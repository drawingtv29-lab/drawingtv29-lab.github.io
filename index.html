<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apna Study Apna Group - Professional</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for browsers -->
    <meta name="theme-color" content="#0052D4">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <style>
        :root {
            --primary-color: #0052D4; --secondary-color: #65C7F7;
            --gradient-start: #0052D4; --gradient-end: #4364F7;
            --bg-color: #f8f9fa; --text-color: #343a40; /* Subtle light gray background */
            --text-color-light: #ffffff; --card-bg: #ffffff; /* White cards */
            --shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.08);
            --shadow-hover: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -2px rgba(0,0,0,0.05);
            --border-radius: 12px; --bottom-nav-height: 65px;
            --success-color: #20bf55; --error-color: #e74c3c;
            --zone-promotion: #A3E635; --zone-safety: #FACC15; --zone-demotion: #EF4444;
            --xp-color: #4F46E5; --gold-glow: #ffd700; --silver-glow: #c0c0c0; --bronze-glow: #cd7f32;
        }
        [data-theme="dark"] {
            --primary-color: #3f51b5; --secondary-color: #03a9f4;
            --gradient-start: #3f51b5; --gradient-end: #03a9f4;
            --bg-color: #121212; --text-color: #e0e0e0; --card-bg: #1e1e1e;
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
            --shadow-hover: 0 10px 25px rgba(0,0,0,0.5);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        html, body { height: 100%; }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        /* --- Animations & Effects --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- Splash Screen --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        .splash-logo {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        .splash-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }

        .hidden { display: none !important; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); text-decoration: none; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background-image: linear-gradient(45deg, var(--gradient-start) 0%, var(--gradient-end) 100%); color: var(--text-color-light); box-shadow: 0 4px 15px 0 rgba(67, 100, 247, 0.35); }
        .btn-primary:hover { box-shadow: 0 6px 20px 0 rgba(67, 100, 247, 0.45); transform: translateY(-2px); }
        .btn-secondary { background-color: #e9ecef; color: #495057; }
        .btn-danger { background-color: var(--error-color); color: white; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--card-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.04); position: sticky; top: 0; z-index: 1001; }
        .logo-container { display: flex; align-items: center; gap: 10px; }
        .app-logo-img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .logo { font-size: 1.6rem; font-weight: 700; color: var(--primary-color); }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .icon-btn { background: none; border: none; cursor: pointer; position: relative; color: var(--text-color); padding: 5px; border-radius: 50%; transition: background-color 0.2s; }
        .icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        .icon-btn svg { width: 26px; height: 26px; }
        #notification-badge { position: absolute; top: 2px; right: 2px; background-color: red; color: white; width: 10px; height: 10px; border-radius: 50%; display: none; border: 1px solid var(--card-bg); }
        #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #side-menu { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: var(--card-bg); z-index: 3001; transform: translateX(-100%); transition: transform 0.3s ease; display: flex; flex-direction: column; overflow-y: auto; }
        body.menu-open { overflow: hidden; }
        body.menu-open #menu-overlay { opacity: 1; pointer-events: auto; }
        body.menu-open #side-menu { transform: translateX(0); }
        .menu-nav a { transition: background-color 0.2s; border-left: 3px solid transparent; }
        .menu-nav a:hover { background-color: #f1f3f5; border-left-color: var(--primary-color); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        
        /* --- Top Search Bar (MODIFIED) --- */
        .top-search-bar { 
            display: flex; align-items: center; background-color: var(--card-bg); 
            border-radius: var(--border-radius); padding: 10px 15px; 
            box-shadow: var(--shadow); cursor: pointer; transition: all 0.3s;
            border: 2px solid var(--primary-color); /* Added blue border */
        }
        .top-search-bar:hover { box-shadow: var(--shadow-hover); transform: translateY(-1px); }
        .top-search-bar input { border: none; outline: none; background: transparent; width: 100%; font-size: 1rem; color: var(--text-color); pointer-events: none; }
        .top-search-bar .search-icon { color: var(--primary-color); opacity: 0.8; margin-right: 10px; }
        .top-search-bar .search-icon svg { width: 22px; height: 22px; }

        /* --- Generic Carousel Styles --- */
        .carousel-container { border-radius: var(--border-radius); overflow: hidden; position: relative; box-shadow: var(--shadow); background: #eee; -webkit-user-select: none; user-select: none;}
        .carousel-track { display: flex; height: 100%; transition: transform 0.5s ease-in-out; }
        .carousel-slide { min-width: 100%; flex-shrink: 0; height: 100%; cursor: pointer; }
        .carousel-slide img, .carousel-slide video { width: 100%; height: 100%; display: block; object-fit: cover; }

        /* --- Hero Carousel with Dots (Main Banner) --- */
        .hero-carousel-wrapper { padding: 0 15px; margin-bottom: 40px; position: relative; }
        #hero-carousel-container { aspect-ratio: 16 / 9; cursor: grab; }
        #hero-carousel-container:active { cursor: grabbing; }
        .carousel-dots { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--primary-color); opacity: 0.3; cursor: pointer; transition: all 0.3s; }
        .dot.active { opacity: 1; transform: scale(1.2); }
        
        /* --- Top Banner Styles (NEW) --- */
        #top-banner-wrapper { padding: 10px 15px; }
        #top-banner-wrapper a { text-decoration: none; display: block; }
        #top-banner-wrapper img,
        #top-banner-wrapper video { 
            width: 100%; 
            height: auto; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow);
            display: block;
        }

        /* --- Quick Links Sections (MODIFIED) --- */
        .quick-links-section-wrapper { padding: 5px 20px; animation: slideInUp 0.7s ease-out; }
        .quick-links-card { /* Removed styles to make it blend with background */ }
        .quick-links-container { display: flex; overflow-x: auto; gap: 15px; padding: 0 10px; scrollbar-width: none; -ms-overflow-style: none; justify-content: flex-start; }
        .quick-links-container::-webkit-scrollbar { display: none; }
        .quick-link-item { display: flex; flex-direction: column; align-items: center; gap: 5px; text-decoration: none; color: var(--text-color); flex: 0 0 62px; transition: transform 0.2s; }
        .quick-link-item:hover { transform: scale(1.05); }
        .quick-link-icon {
            width: 55px;
            height: 55px;
            border-radius: 12px;
            background: transparent;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .quick-link-item:hover .quick-link-icon { transform: scale(1.1); }
        .quick-link-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }
        .quick-link-icon svg { width: 70%; height: 70%; object-fit: contain; }
        .quick-link-item span { font-size: 0.65rem; font-weight: 500; text-align: center; line-height: 1.2; }


        #auth-container { min-height: 100vh; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .auth-page { width:100%; }
        .auth-form-container { width: 100%; max-width: 400px; background: var(--card-bg); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .auth-page .logo-container { justify-content: center; margin-bottom: 25px; }
        .auth-page .logo { font-size: 2rem; }
        .auth-page h2 { text-align: center; margin-bottom: 20px; font-weight: 600; }
        #main-app-container { padding-bottom: var(--bottom-nav-height); }
        .auth-nav { display: flex; justify-content: center; margin-bottom: 20px; background: var(--card-bg); padding: 5px; border-radius: 10px; box-shadow: var(--shadow); width: 100%; max-width: 400px; }
        .auth-nav-btn { flex: 1; padding: 10px; background: transparent; border: none; cursor: pointer; font-weight: 600; color: var(--text-color); opacity: 0.7; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .auth-nav-btn.active { color: var(--primary-color); opacity: 1; border-bottom-color: var(--primary-color); }

        .section-title { font-size: 1.5rem; font-weight: 700; margin: 30px 20px 20px; display: flex; justify-content: space-between; align-items: center; animation: slideInUp 0.8s ease-out; }
        #page-home #home-our-batches-container .section-title { margin-top: 20px; }
        #page-home #home-other-batches-container .section-title { margin-top: 25px; }

        .section-title a { font-size: 0.9rem; font-weight: 500; text-decoration: none; color: var(--primary-color); }
        .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 0 20px; }
        .course-card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; transition: transform 0.3s, box-shadow 0.3s; animation: slideInUp 0.9s ease-out; }
        .course-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        .course-thumbnail { width: 100%; aspect-ratio: 16 / 9; overflow: hidden; }
        .course-thumbnail img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
        .course-card:hover .course-thumbnail img { transform: scale(1.05); }
        .course-card-content { padding: 20px 20px 15px; }
        .course-card h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 8px; line-height: 1.4; }
        .course-card p { font-size: 0.9rem; color: #6c757d; margin-bottom: 15px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .card-footer { padding: 0 20px 20px; margin-top: auto; }
        .card-divider { height: 1px; background-color: #f0f0f0; margin: 0 0 15px 0; }
        [data-theme="dark"] .card-divider { background-color: #333; }
        .price-container { margin-bottom: 15px; }
        .price { font-size: 1.6rem; font-weight: 700; color: var(--primary-color); }
        .price.free { color: var(--success-color); font-size: 1.3rem; }
        .original-price { text-decoration: line-through; color: #888; margin-left: 8px; font-size: 1rem; }
        .discount-tag { display: inline-block; background-color: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; margin-top: 5px; }
        .card-buttons { display: flex; gap: 10px; }
        .card-buttons .btn { flex: 1; padding: 10px; font-size: 0.9rem; }
        .lets-study-btn { width: 100%; }
        .course-scroll-container { display: flex; overflow-x: auto; gap: 15px; padding: 0 20px 15px; scrollbar-width: none; -ms-overflow-style: none;}
        .course-scroll-container::-webkit-scrollbar { display: none; }
        .course-scroll-container .course-card { flex: 0 0 260px; width: 260px; }
        .course-scroll-container .course-card h3 { font-size: 1rem; }
        .course-scroll-container .course-card p { -webkit-line-clamp: 1; }
        .course-scroll-container .course-card-content { padding-bottom: 10px; }
        .course-scroll-container .course-card p { margin-bottom: 0; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--bottom-nav-height); background: var(--card-bg); display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.06); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; color: #999; text-decoration: none; border-top: 3px solid transparent; padding-top: 5px; transition: color 0.2s; }
        .nav-item.active { color: var(--primary-color); border-top-color: var(--primary-color); font-weight: 600; }
        .nav-item svg { width: 24px; height: 24px; transition: transform 0.2s; }
        .nav-item.active svg { transform: scale(1.1); }
        .nav-item span { font-size: 0.75rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 400px; transform: scale(0.95) translateY(10px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-overlay.visible .modal-content { transform: scale(1) translateY(0); }
        .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .detail-page-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 2500; overflow-y: auto; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .detail-page-container.visible { transform: translateX(0); }
        .detail-header { display: flex; align-items: center; padding: 10px; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; background: var(--card-bg);}
        .back-btn { background: none; border: none; cursor: pointer; margin-right: 10px; padding: 12px; border-radius: 50%;}
        .back-btn svg { width: 28px; height: 28px; color: var(--text-color); display: block; }
        .detail-title { font-size: 1.2rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .detail-content { padding: 20px; }
        
        .detail-content img,
        #page-about-us img,
        .notification-link + img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            cursor: pointer;
        }

        .detail-description { white-space: pre-wrap; line-height: 1.6; }
        .detail-footer { padding: 20px; background: var(--card-bg); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); position: sticky; bottom: 0; }
        .menu-header { padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; }
        .menu-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 600; }
        .menu-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .menu-user-info { display: flex; flex-direction: column; }
        .menu-user-name { font-weight: 600; font-size: 1.1rem; }
        .menu-user-view-profile { font-size: 0.9rem; color: var(--primary-color); text-decoration: none; cursor: pointer; font-weight: 500;}
        .menu-nav { list-style: none; padding: 15px 0; }
        .menu-nav a { display: flex; align-items: center; gap: 15px; padding: 15px 20px; color: var(--text-color); text-decoration: none; font-weight: 500; }
        .menu-nav a svg { width: 22px; height: 22px; opacity: 0.8; }
        .menu-footer { padding: 20px; border-top: 1px solid #eee; margin-top: auto; }
        .menu-credit { text-align: center; font-size: 0.8rem; color: #999; margin-top: 15px; }
        
        .empty-state { text-align: center; padding: 50px 20px; color: #777; }
        /* Search Page (MODIFIED) */
        .search-page { padding: 20px; }
        .search-bar { 
            width: 100%; 
            padding: 15px; 
            font-size: 1.1rem; 
            border: 2px solid var(--primary-color); 
            border-radius: var(--border-radius); 
            margin-bottom: 25px; 
            background-color: var(--card-bg); 
            color: var(--text-color); 
            box-shadow: none;
            transition: box-shadow 0.3s;
        }
        .search-bar:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 82, 212, 0.25);
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background-color: var(--card-bg); color: var(--text-color); appearance: none; font-family: 'Poppins', sans-serif; }
        .password-wrapper { position: relative; }
        .password-toggle { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #888; }
        .clickable-link { color: var(--primary-color); cursor: pointer; text-decoration: underline; font-size: 0.9rem; margin-top: 10px; display: inline-block; }
        
        /* Filter Bar Styles */
        .filter-bar-container { display: flex; gap: 10px; padding: 15px 20px; background-color: var(--card-bg); border-bottom: 1px solid #eee; align-items: center; }
        .filter-bar-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid #ddd; background-color: transparent; cursor: pointer; font-weight: 500; }
        .filter-bar-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .filter-bar-select { padding: 8px 12px; border-radius: 20px; border: 1px solid #ddd; background-color: var(--card-bg); color: var(--text-color); font-weight: 500; flex-grow: 1; }

        /* Profile Page Styles */
        #page-profile { padding-bottom: 30px; }
        .profile-header-card, .profile-details-card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); margin: 20px; padding: 25px; }
        .profile-picture-section { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; }
        .profile-page-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 4px solid var(--primary-color); }
        .profile-page-avatar-initial { display:flex; align-items:center; justify-content:center; font-size: 3.5rem; background-color: var(--primary-color); color: white; border: none; }
        .profile-user-details { display: flex; flex-direction: column; }
        .profile-user-details .username { font-size: 1.5rem; font-weight: 600; margin-bottom: 8px; }
        .change-picture-btn {
            padding: 8px 18px; font-size: 0.9rem; cursor: pointer;
            background-color: var(--primary-color); color: white;
            border: none; border-radius: 8px; font-weight: 600;
            transition: opacity 0.3s;
        }
        .change-picture-btn:hover { opacity: 0.9; }

        .level-overview-section { display: flex; justify-content: space-around; text-align: center; padding-top: 20px; border-top: 1px solid #eee; }
        .level-overview-section div h4 { font-size: 1.8rem; font-weight: 700; color: var(--xp-color); margin-bottom: 2px; }
        .level-overview-section div p { font-size: 0.9rem; color: #777; font-weight: 500; }
        .profile-details-card .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .profile-details-card .section-header h3 { font-size: 1.2rem; font-weight: 600; margin: 0; }
        .edit-btn { font-size: 0.9rem; font-weight: 600; color: var(--primary-color); cursor: pointer; background: none; border: none; padding: 5px; }
        .details-list .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 5px; border-bottom: 1px solid #f1f1f1; font-size: 1rem; }
        .details-list .detail-item.clickable { cursor: pointer; }
        .details-list .detail-item:last-child { border-bottom: none; }
        .details-list .detail-item span:first-child { font-weight: 500; color: #888; }
        .details-list .detail-item span:last-child { font-weight: 500; text-align: right; }
        .details-list .detail-item .arrow { color: #ccc; }
        #profile-logout-btn { width: calc(100% - 40px); margin: 0 20px 20px 20px; background-color: var(--error-color); color: white; }
        .dark-mode-row { display: flex; justify-content: space-between; align-items: center; }
        .dark-mode-label { font-size: 1rem; font-weight: 500; }
        .dark-mode-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .dark-mode-switch input { opacity: 0; width: 0; height: 0; }
        .dark-mode-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .dark-mode-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        .dark-mode-switch input:checked + .dark-mode-slider { background-color: var(--primary-color); }
        .dark-mode-switch input:checked + .dark-mode-slider:before { transform: translateX(22px); }
        
        /* Buy Now Page Styles */
        #page-buy-now { padding-bottom: 120px; }
        .buy-now-wrapper { padding: 20px; }
        .buy-now-thumbnail { width: 100%; aspect-ratio: 16/9; border-radius: var(--border-radius); overflow: hidden; margin-bottom: 20px; box-shadow: var(--shadow); }
        .buy-now-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .buy-now-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; }
        .buy-now-points { list-style: none; padding: 0; margin-bottom: 25px; }
        .buy-now-points li { margin-bottom: 12px; padding-left: 35px; position: relative; font-size: 1rem; }
        .payment-details-card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 20px; }
        .payment-details-card h4 { font-size: 1.3rem; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .payment-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1rem; }
        .payment-row span:last-child { font-weight: 600; }
        .payment-row.total { font-weight: 700; font-size: 1.2rem; border-top: 2px solid #333; padding-top: 12px; margin-top: 10px; }
        .buy-now-footer { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .proceed-btn { width: 100%; padding: 15px; font-size: 1.1rem; }
        .proceed-btn .discount-info { font-size: 0.8rem; opacity: 0.9; display: block; margin-top: 4px; }
        
        /* --- Quiz Styles --- */
        .quiz-container { padding: 20px; }
        .quiz-list-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 15px; cursor: pointer; }
        .quiz-question-card { background: var(--card-bg); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 20px; }
        .quiz-question-text { font-size: 1.1rem; font-weight: 500; margin-bottom: 20px; }
        .quiz-options { list-style: none; }
        .quiz-option { 
            position: relative; 
            display: flex;
            align-items: center;
            padding: 15px; 
            padding-right: 40px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .quiz-option::after {
            content: '';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            font-weight: bold;
        }
        .quiz-option.selected { background-color: var(--secondary-color) !important; color: white; border-color: var(--secondary-color); }
        .quiz-option.correct { 
            background-color: var(--success-color); 
            color: white; 
            border-color: var(--success-color); 
            pointer-events: none; 
        }
        .quiz-option.correct::after {
            content: '✔';
            color: white;
        }
        .quiz-option.incorrect { 
            background-color: var(--error-color); 
            color: white; 
            border-color: var(--error-color); 
            pointer-events: none; 
        }
        .quiz-option.incorrect::after {
            content: '✖';
            color: white;
        }
        .quiz-navigation { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }

        /* --- New Quiz Result Card (MODIFIED) --- */
        #quiz-result-content-container { padding: 15px; }
        .quiz-result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .quiz-result-title { font-size: 1.3rem; font-weight: 600; }
        .quiz-result-card-new { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 15px; box-shadow: var(--shadow); margin-bottom: 15px; }
        .score-card { display: flex; justify-content: space-between; align-items: center; }
        .score-label { font-size: 1rem; font-weight: 500; color: #666; }
        .score-value { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        .details-card .progress-item:not(:last-child) { margin-bottom: 15px; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.9rem; }
        .progress-value { font-weight: 500; }
        .progress-bar-wrapper { height: 8px; width: 100%; background-color: #e9ecef; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 4px; }
        .progress-bar.correct { background-color: var(--success-color); }
        .progress-bar.incorrect { background-color: var(--error-color); }
        .summary-list { list-style: none; padding: 0; font-size: 0.9rem; }
        .summary-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .summary-list li:last-child { border-bottom: none; }
        .summary-list span:first-child { color: #555; }
        .summary-list span:last-child { font-weight: 500; }
        .feedback-card { display: flex; justify-content: space-between; align-items: center; }
        .feedback-text { font-size: 1rem; font-weight: 500; }
        .feedback-emoji { font-size: 1.5rem; }

        /* --- NEW: Quiz Ranks Page --- */
        #page-quiz-ranks { padding: 0; }
        #quiz-ranks-container { padding: 20px; }
        .your-rank-highlight {
            background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
            box-shadow: var(--shadow-hover);
        }
        .your-rank-highlight p { margin: 0; font-size: 1rem; }
        .your-rank-highlight .rank-number { font-size: 2.5rem; font-weight: 700; }
        .quiz-rank-list-item {
            display: grid;
            grid-template-columns: 40px 1fr 60px;
            align-items: center;
            padding: 10px 15px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .quiz-rank-list-item.current-user-rank {
            border: 2px solid var(--primary-color);
            background-color: #eef2ff;
        }
        /* Top 3 Highlighting */
        .quiz-rank-list-item.rank-1 { background: linear-gradient(90deg, #fff1c2, #ffffff); }
        .quiz-rank-list-item.rank-2 { background: linear-gradient(90deg, #dce0e3, #ffffff); }
        .quiz-rank-list-item.rank-3 { background: linear-gradient(90deg, #f7d7c6, #ffffff); }
        .quiz-rank-number { font-size: 1rem; font-weight: 700; text-align: center; color: #555; }
        .quiz-rank-user-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 10px;}
        .quiz-rank-score { font-size: 1rem; font-weight: 600; color: var(--primary-color); text-align: right; }


        .pdf-list { padding: 20px; display: grid; gap: 15px; }
        .pdf-item { display: flex; flex-direction: column; padding: 20px; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); }
        .pdf-item-info { flex-grow: 1; margin-bottom: 15px; }
        .pdf-item-info h4 { margin: 0; font-size: 1.1rem; font-weight: 600; }
        .pdf-item-info p { font-size: 0.9rem; color: #777; margin-top: 5px; }
        .pdf-item-actions { display: flex; gap: 10px; }
        .pdf-item-actions .btn { flex: 1; text-align: center; text-decoration: none; }
        .subject-accordion-item { background: var(--card-bg); border-radius: var(--border-radius); margin-bottom: 15px; box-shadow: var(--shadow); overflow: hidden; cursor:pointer; transition: box-shadow 0.3s; }
        .subject-accordion-item:hover { box-shadow: var(--shadow-hover); }
        .subject-header { display: flex; align-items: center; padding: 20px; }
        .subject-logo { width: 45px; height: 45px; border-radius: 50%; background-image: linear-gradient(45deg, var(--gradient-start) 0%, var(--gradient-end) 100%); color: var(--text-color-light); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; font-weight: 600; margin-right: 15px; flex-shrink: 0; }
        .subject-logo img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .subject-title { font-weight: 600; flex-grow: 1; font-size: 1.1rem; }
        .subject-arrow { transition: transform 0.3s; }
        .subject-arrow svg { width: 24px; height: 24px; }
        .chapter-card { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); border-radius: var(--border-radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .chapter-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
        .chapter-info h4 { font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; }
        .chapter-info p { color: #777; font-size: 0.9rem; }
        .chapter-arrow svg { width: 24px; height: 24px; color: #aaa; }
        
        #page-lectures .detail-header .detail-title { flex-grow: 1; }
        .filter-container { display: flex; gap: 10px; padding: 15px 20px; border-bottom: 1px solid #eee; overflow-x: auto; }
        .filter-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid #ddd; background-color: transparent; cursor: pointer; font-weight: 500; transition: all 0.3s; white-space: nowrap; }
        .filter-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .lecture-content-list { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .content-card-wrapper { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); border-left: 5px solid var(--success-color); }
        .content-card { padding: 15px; position: relative; }
        .content-card-main { display: flex; gap: 15px; align-items: center; }
        .content-thumbnail { flex-shrink: 0; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; position: relative; background-color: #e9ecef; }
        .content-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .content-time-overlay { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; font-size: 0.75rem; padding: 2px 5px; border-radius: 4px; }
        .content-details { flex-grow: 1; }
        .content-meta { font-size: 0.8rem; color: #888; margin-bottom: 5px; font-weight: 500; }
        .content-title { font-size: 1rem; font-weight: 600; margin-bottom: 10px; }
        .content-actions { display: flex; align-items: center; gap: 15px; }
        .content-action-btn { display: flex; align-items: center; gap: 5px; padding: 6px 10px; border-radius: 6px; background-color: #f1f3f5; font-size: 0.8rem; font-weight: 500; color: var(--text-color); text-decoration: none; transition: background-color 0.2s; }
        .content-action-btn.watch { color: var(--primary-color); }
        .content-action-btn:hover { background-color: #e9ecef; }
        .content-action-btn svg { width: 16px; height: 16px; }
        .content-action-btn.icon { padding: 8px; border: 1px solid #ddd; }
        /* REMOVED: .downloaded state for download button as it's no longer needed */
        .content-complete-btn { position: absolute; top: 15px; right: 15px; width: 28px; height: 28px; border-radius: 50%; border: 2px solid #ccc; background: white; transition: all 0.3s; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; }
        .content-complete-btn.completed { background-color: var(--success-color); border-color: var(--success-color); color: white; pointer-events: none; }

        #page-leaderboard { padding-bottom: 20px; }
        .leaderboard-level-showcase { padding: 20px 0; background: var(--card-bg); position: relative; display: flex; justify-content: center; align-items: center; height: 150px; overflow: hidden; }
        .current-level-pillar { position: relative; z-index: 10; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .current-level-pillar::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 150px; height: 150px; background: radial-gradient(circle, rgba(255, 215, 0, 0.4), transparent 70%); z-index: -1; animation: pulse 2.5s infinite ease-out; }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.7; } 70% { transform: translate(-50%, -50%) scale(1.4); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } }
        .current-level-pillar .level-badge-item { transform: scale(1.3); box-shadow: 0 0 25px 5px var(--glow-color, #fff), inset 0 0 10px rgba(255,255,255,0.5); opacity: 1; }
        .current-level-pillar-text { margin-top: 15px; font-size: 1rem; font-weight: 600; color: var(--text-color); text-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .level-carousel-track { display: flex; gap: 25px; position: absolute; left: 50%; align-items: center; transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .level-badge-item { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; font-weight: 700; flex-shrink: 0; transition: all 0.3s; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.2); opacity: 0.5; transform: scale(0.7); }
        .leaderboard-zone-container { padding: 20px; background-color: var(--card-bg); border-radius: var(--border-radius); margin: 0 20px 20px; box-shadow: var(--shadow); }
        .zone-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .zone-header p { font-weight: 500; }
        .zone-bar-wrapper { position: relative; width: 100%; padding-bottom: 25px; }
        .zone-bar { display: flex; width: 100%; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .zone-bar-segment { height: 100%; }
        .zone-demotion-bar { background-color: var(--zone-demotion); width: 13.33%; }
        .zone-safety-bar { background-color: var(--zone-safety); width: 40%; }
        .zone-promotion-bar { background-color: var(--zone-promotion); width: 46.67%; }
        .zone-top-labels, .zone-bottom-labels { display: flex; font-size: 0.75rem; color: #777; }
        .zone-top-labels div:nth-child(1) { width: 13.33%; text-align: center; }
        .zone-top-labels div:nth-child(2) { width: 40%; text-align: center; }
        .zone-top-labels div:nth-child(3) { width: 46.67%; text-align: center; }
        .zone-bottom-labels { justify-content: space-between; margin-top: 8px; padding: 0 5px; }
        .user-rank-indicator { position: absolute; bottom: 0px; transform: translateX(-50%); transition: left 0.5s ease; text-align: center; }
        .user-rank-box { background-color: var(--primary-color); color: white; padding: 4px 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space: nowrap; }
        .user-rank-arrow { width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid var(--primary-color); margin: 0 auto; }
        .leaderboard-list { display: flex; flex-direction: column; gap: 12px; padding: 0 20px; }
        .leaderboard-item { display: flex; align-items: center; padding: 15px; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); transition: all 0.3s; border-left: 5px solid transparent; }
        .leaderboard-item.current-user { border: 2px solid var(--primary-color); background-color: #eef2ff; }
        .rank { font-size: 1.2rem; font-weight: 700; min-width: 40px; text-align: center; position: relative; color: #576574; }
        .leaderboard-item.rank-1 .rank, .leaderboard-item.rank-2 .rank, .leaderboard-item.rank-3 .rank { font-size: 1.8rem; }
        .rank-icon { font-size: 1.5rem; }
        .leaderboard-user-name { font-weight: 600; flex-grow: 1; margin-left: 15px; }
        .leaderboard-xp { font-size: 1.1rem; font-weight: 600; color: var(--xp-color); margin-left: auto; text-align: right; }
        .xp-label { font-size: 0.8rem; opacity: 0.7; }
        .promotion-zone { border-left-color: var(--zone-promotion); }
        .safety-zone { border-left-color: var(--zone-safety); }
        .demotion-zone { border-left-color: var(--zone-demotion); }
        @keyframes glow { 0% { box-shadow: 0 0 5px var(--glow-color); } 50% { box-shadow: 0 0 20px var(--glow-color); } 100% { box-shadow: 0 0 5px var(--glow-color); } }
        .leaderboard-item.rank-1 { background: linear-gradient(to right, #fff, #f1e76744); --glow-color: var(--gold-glow); }
        .leaderboard-item.rank-2 { background: linear-gradient(to right, #fff, #c0c0c044); --glow-color: var(--silver-glow); }
        .leaderboard-item.rank-3 { background: linear-gradient(to right, #fff, #cd7f3244); --glow-color: var(--bronze-glow); }
        
        /* --- Video Player Page Styles --- */
        #page-video-player.active { display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 4000; overflow-y: auto; }
        #page-video-player .detail-header { position: static; flex-shrink: 0; box-shadow: none; border-bottom: 1px solid #eee; }
        #page-video-player .back-btn { padding: 8px; }
        #page-video-player .back-btn svg { width: 24px; height: 24px; }
        #page-video-player .detail-title { font-size: 1rem; }
        .video-wrapper { width: 100%; aspect-ratio: 16 / 9; background-color: #000; position: relative; flex-shrink: 0; }
        #video-player-element { width: 100%; height: 100%; }
        .video-content-container { padding: 15px; }
        .video-actions-container { background: var(--card-bg); border-radius: var(--border-radius); padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); }
        #video-player-title { font-size: 1.2rem; font-weight: 600; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; }
        .video-actions-scroll { display: flex; justify-content: space-around; gap: 10px; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; }
        .action-circle { display: flex; flex-direction: column; align-items: center; gap: 5px; text-decoration: none; color: var(--text-color); cursor: pointer; position: relative; }
        .action-icon-wrapper { width: 48px; height: 48px; border-radius: 50%; background-color: #f1f3f5; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s, color 0.3s; }
        .action-circle.active .action-icon-wrapper { background-color: var(--primary-color); }
        .action-circle.active .action-icon-wrapper svg { color: white; }
        .action-icon-wrapper svg { width: 22px; height: 22px; color: var(--primary-color); transition: color 0.3s; }
        .action-circle span { font-size: 0.7rem; font-weight: 500; }
        .video-input-bar { display: flex; align-items: center; gap: 10px; }
        .video-input-bar textarea { flex-grow: 1; resize: none; max-height: 80px; height: 45px; padding: 12px; border: 1px solid #ddd; border-radius: 22px; background: #f1f3f5; }
        .video-input-bar button { width: 45px; height: 45px; padding: 0; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .video-input-bar button svg { width: 24px; height: 24px; }
        .video-content-section { padding: 0; }
        .comment-list, .question-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 15px; }

        .comment-item, .question-item {
            display: flex;
            gap: 8px;
            padding: 8px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .question-item { border-left: 4px solid var(--error-color); }
        .comment-avatar, .question-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
            flex-shrink: 0;
        }
        .comment-avatar img, .question-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .comment-content, .question-content { flex-grow: 1; }
        .comment-author-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        .comment-author, .question-author {
            font-weight: 600;
            font-size: 0.8rem;
        }
        .comment-text, .question-text {
            line-height: 1.4;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .comment-meta, .question-meta {
            font-size: 0.65rem;
            color: #888;
            margin-top: 0;
        }
        .delete-comment-btn, .delete-question-btn { cursor: pointer; color: var(--error-color); font-weight: 500; margin-left: 10px; }
        
        /* PDF Viewer Page Styles */
        #page-pdf-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 4000; background-color: var(--bg-color); flex-direction: column; }
        #page-pdf-viewer.active { display: flex; }
        .pdf-viewer-container { flex-grow: 1; overflow: hidden; }
        .pdf-viewer-iframe { width: 100%; height: 100%; border: none; }
        .detail-header-actions { position: relative; margin-left: auto; }
        .dropdown-menu { display: none; position: absolute; top: 100%; right: 0; background-color: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); z-index: 10; min-width: 160px; overflow: hidden; }
        .dropdown-menu.visible { display: block; }
        .dropdown-item { display: block; padding: 12px 18px; color: var(--text-color); text-decoration: none; font-size: 0.9rem; }
        .dropdown-item:hover { background-color: #f1f3f5; }
        [data-theme="dark"] .dropdown-item:hover { background-color: #333; }
        
        /* Notification Link Style */
        .notification-link {
            color: var(--primary-color);
            text-decoration: underline;
            font-weight: 500;
            word-break: break-all;
        }

        /* --- Payment Page Styles --- */
        #page-payment-gateway .payment-wrapper { padding: 20px; }
        .payment-card { background: var(--card-bg); border-radius: var(--border-radius); padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .payment-card h3 { font-size: 1.3rem; margin-bottom: 15px; }
        .payment-card p { margin-bottom: 10px; line-height: 1.5; }
        .order-id-box { background: #e9ecef; border-radius: 8px; padding: 15px; text-align: center; margin: 20px 0; border: 2px dashed var(--primary-color); }
        .order-id-box p { margin: 0 0 8px 0; font-weight: 500; }
        .order-id-box .the-id { font-size: 1.5rem; font-weight: 700; letter-spacing: 2px; color: var(--primary-color); user-select: all; }
        .copy-btn { margin-top: 10px; background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 8px 15px; font-size: 0.8rem; }
        .important-instruction { background-color: #fff9e6; color: #856404; padding: 15px; border-radius: 8px; margin: 20px 0; font-weight: 500; border-left: 5px solid #ffc107;}
        .qr-code-container { text-align: center; }
        .qr-code-container img { max-width: 250px; width: 100%; border-radius: 8px; border: 1px solid #ddd; }
        .upi-id-text { font-weight: 600; margin-top: 10px; user-select: all; }
        .utr-info-card { background-color: #f0f4ff; border: 1px solid #c3daff; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .utr-info-card h4 { margin-top: 0; color: var(--primary-color); }
        .utr-info-card p { font-size: 0.9rem; line-height: 1.5; }
        .utr-info-card strong { color: #333; }

        /* --- UPDATED: Contact Us Chat Page Styles --- */
        #page-contact-us {
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; 
            z-index: 2600;
            background-color: #0b141a;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #page-contact-us.active { transform: translateX(0); }
        #page-contact-us .detail-header { 
            gap: 10px; 
            background-color: #1f2c34;
            color: #e9edef;
            border-bottom: 1px solid #2a3942;
            flex-shrink: 0;
        }
        #page-contact-us .back-btn svg { color: #e9edef; }
        .chat-header-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .chat-area {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-image: url("data:image/svg+xml,%3Csvg width='400' height='400' viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%231c2c35' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M0 400L400 0H200L0 200M400 400V200L200 400'/%3E%3C/g%3E%3C/svg%3E");
        }
        .date-separator {
            align-self: center;
            background-color: #182229;
            color: #aebac1;
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 500;
            margin: 10px 0;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .message-bubble-wrapper { display: flex; margin-bottom: 8px; max-width: 80%; position: relative; }
        .message-bubble-wrapper.sent { align-self: flex-end; }
        .message-bubble-wrapper.received { align-self: flex-start; }
        .message-bubble-content { position: relative; padding: 6px 12px; min-width: 80px; border-radius: 8px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .message-bubble-wrapper.sent .message-bubble-content { background-color: #005c4b; color: #e9edef; border-top-right-radius: 0; }
        .message-bubble-wrapper.received .message-bubble-content { background-color: #202c33; color: #e9edef; border-top-left-radius: 0; }
        .message-text { white-space: pre-wrap; word-wrap: break-word; font-size: 0.95rem; padding-bottom: 15px; }
        .message-time { position: absolute; bottom: 4px; right: 8px; font-size: 0.7rem; color: #aebac1; }
        .chat-form-container {
            flex-shrink: 0;
            background-color: #1f2c34;
            padding: 8px;
        }
        .chat-form { display: flex; align-items: flex-end; gap: 8px; }
        .chat-input-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            background-color: #2a3942;
            border-radius: 22px;
            padding: 0 15px;
        }
        .chat-form textarea {
            flex-grow: 1;
            border: none;
            padding: 10px 0;
            background: transparent;
            resize: none;
            max-height: 100px;
            font-size: 1rem;
            color: white;
            scrollbar-width: none;
        }
        .chat-form textarea:focus {
            outline: none;
            box-shadow: none;
        }
        .chat-form textarea::-webkit-scrollbar { display: none; }
        .chat-form .icon-btn { flex-shrink: 0; }
        .chat-form #user-chat-send-btn { background-color: var(--primary-color); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
        .chat-form #user-chat-send-btn svg { fill: white; margin-left: 2px; }
        .chat-subtext { font-size: 0.8rem; font-weight: 500; color: #aebac1; text-align: center; padding-top: 5px; }
        
        /* --- STUDY PAGE STYLES (MODIFIED) --- */
        #study-page-content {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 58px);
        }
        .study-main-area {
            flex-grow: 1;
        }
        #page-study .detail-header { /* NEW for XP */
            justify-content: space-between;
        }
        #header-xp-display {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 20px;
            background-color: #f0f0f0;
        }
        .xp-icon {
            width: 24px;
            height: 26px;
            background-color: var(--xp-color);
            color: white;
            font-size: 0.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }
        .xp-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--xp-color);
        }
        #page-study .study-header {
            padding: 15px 20px;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
        }
        #study-batch-selector {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        .study-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            padding: 25px 20px 15px;
        }
        .today-classes-container {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 0 20px 15px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .today-classes-container::-webkit-scrollbar { display: none; }
        .class-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            flex: 0 0 250px;
            width: 250px;
            overflow: hidden;
            cursor: pointer;
        }
        .class-card-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            position: relative;
            background-color: #eee;
        }
        .class-card-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .class-card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 10px;
        }
        .class-card-teacher {
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .class-status-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }
        .class-status-badge.upcoming { background-color: #ff9800; }
        .class-status-badge.live { background-color: #e53935; animation: pulse-live 1.5s infinite; }
        @keyframes pulse-live { 0% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(229, 57, 53, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0); } }

        .class-card-content { padding: 15px; }
        .class-card-content h4 { font-size: 1rem; font-weight: 600; margin-bottom: 5px; }
        .class-card-content .class-time { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: #555; }
        .class-card-content .class-time svg { width: 16px; height: 16px; opacity: 0.7; }
        
        .view-all-classes-link {
            display: block;
            text-align: center;
            margin: 10px 20px 0;
            font-weight: 600;
            color: var(--primary-color);
            text-decoration: none;
        }

        .my-learning-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 0 20px;
        }
        .learning-shortcut-btn {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .learning-shortcut-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        /* --- NEW: DASHBOARD PAGE --- */
        #page-dashboard { padding-bottom: 20px; }
        .dashboard-grid {
            padding: 20px;
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }
        .dashboard-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
        }
        .dashboard-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .dashboard-card-header .icon {
            font-size: 1.5rem;
        }
        .dashboard-card-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }
        .dashboard-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        .dashboard-stat .label {
            font-size: 1rem;
            color: #555;
        }
        .dashboard-stat .value {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .dashboard-stat .value span {
            font-size: 1rem;
            font-weight: 500;
            color: #777;
        }

        /* --- LIVE CLASS PAGE STYLES (FIXED) --- */
        #live-class-content-container { display: flex; flex-direction: column; height: calc(100vh - 58px); /* 58px is header height */ }
        .live-video-wrapper { width: 100%; aspect-ratio: 16/9; background: #000; flex-shrink: 0; }
        .live-video-wrapper iframe { width: 100%; height: 100%; border: none; }
        .live-details-and-chat { flex-grow: 1; display: flex; flex-direction: column; overflow-y: hidden; /* Prevent this wrapper from scrolling */ }
        .live-video-details { padding: 15px; border-bottom: 1px solid #eee; flex-shrink: 0; }
        #live-video-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; }
        #live-chat-section { flex-grow: 1; display: flex; flex-direction: column; padding: 15px; overflow-y: hidden; /* Also prevent this from scrolling */ }
        #live-chat-messages { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; } /* Reduced gap */
        .live-chat-form-wrapper { flex-shrink: 0; /* This wrapper will contain the form and subtext and will NOT scroll */ }
        #live-chat-form { display: flex; gap: 10px; align-items: center; }
        #live-chat-form input { flex-grow: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #ccc; font-size: 1rem; }
        #live-chat-form button { border-radius: 50%; width: 44px; height: 44px; padding: 0; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        #live-chat-form button svg { width: 24px; height: 24px; }
        .live-chat-subtext {
            font-size: 0.8rem;
            font-weight: 500;
            color: #888;
            text-align: center;
            padding-top: 10px;
        }

        /* --- Image Viewer Modal --- */
        #image-viewer-modal {
            position: fixed;
            z-index: 5000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }
        #image-viewer-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 5001;
        }
        #image-viewer-close:hover { color: #bbb; }
        .image-viewer-content {
            width: 100%;
            height: 100%;
            text-align: center;
            overflow: auto; /* Allows panning/scrolling */
        }
        #image-viewer-img {
            max-width: 95%;
            max-height: 95%;
            margin: auto;
            display: inline-block;
            transition: transform 0.2s ease;
            cursor: zoom-in;
            vertical-align: middle;
        }
        #image-viewer-img.zoomed {
            max-width: none; /* Remove constraints when zoomed */
            max-height: none;
            cursor: grab;
        }
        #image-viewer-img.zoomed:active {
            cursor: grabbing;
        }

    </style>
</head>
<body>
    
    <div id="splash-screen">
        <div class="splash-logo">ApnaStudy</div>
        <div class="splash-spinner"></div>
    </div>

    <div id="auth-container" style="display: none;">
        <div class="auth-nav">
            <button class="auth-nav-btn" data-page="page-auth-signup">Sign Up</button>
            <button class="auth-nav-btn" data-page="page-auth-login">Login</button>
            <button class="auth-nav-btn" data-page="page-auth-forgot-password">Reset Password</button>
        </div>
        
        <div id="page-auth-login" class="page auth-page">
            <div class="auth-form-container">
                <div class="logo-container">
                    <img class="app-logo-img" src="" alt="Logo" style="display: none;">
                    <div class="logo">ApnaStudy</div>
                </div>
                <h2>Welcome Back!</h2>
                <form id="login-form">
                    <div class="form-group"><label>Email</label><input type="email" id="login-email" required></div>
                    <div class="form-group"><label>Password</label><div class="password-wrapper"><input type="password" id="login-password" required><button type="button" class="password-toggle">👁️</button></div></div>
                    <button type="submit" class="btn btn-primary" style="width:100%;">Login</button>
                </form>
            </div>
        </div>

        <div id="page-auth-signup" class="page auth-page">
            <div class="auth-form-container">
                <div class="logo-container">
                    <img class="app-logo-img" src="" alt="Logo" style="display: none;">
                    <div class="logo">ApnaStudy</div>
                </div>
                <h2>Create Your Account</h2>
                <form id="signup-form">
                    <div class="form-group"><label>Username</label><input type="text" id="signup-username" required></div>
                    <div class="form-group"><label>Class</label>
                        <select id="signup-class" required>
                            <option value="" disabled selected>-- अपनी क्लास चुनें --</option>
                            <option value="6">Class 6</option><option value="7">Class 7</option><option value="8">Class 8</option>
                            <option value="9">Class 9</option><option value="10">Class 10</option><option value="11">Class 11</option><option value="12">Class 12</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Email</label><input type="email" id="signup-email" required></div>
                    <div class="form-group"><label>Mobile Number (Optional)</label><input type="tel" id="signup-mobile"></div>
                    <div class="form-group"><label>Password</label><div class="password-wrapper"><input type="password" id="signup-password" minlength="6" required><button type="button" class="password-toggle">👁️</button></div></div>
                    <div class="form-group"><label>Confirm Password</label><div class="password-wrapper"><input type="password" id="signup-confirm-password" minlength="6" required><button type="button" class="password-toggle">👁️</button></div></div>
                    <button type="submit" class="btn btn-primary" style="width:100%;">Create Account</button>
                </form>
            </div>
        </div>

        <div id="page-auth-forgot-password" class="page auth-page">
             <div class="auth-form-container">
                <h2>Reset Password</h2>
                <form id="reset-password-form">
                    <p style="margin-bottom:15px; color:#6c757d;">अपना रजिस्टर्ड ईमेल दर्ज करें। हम आपको पासवर्ड रीसेट करने के लिए एक लिंक भेजेंगे। (कृपया अपना Spam फोल्डर भी जांचें)</p>
                    <div class="form-group"><label>Email</label><input type="email" id="reset-email" required></div>
                    <button type="submit" class="btn btn-primary" style="width:100%;">रीसेट लिंक भेजें</button>
                </form>
            </div>
        </div>
    </div>

    <div id="main-app-container" style="display: none;">
        <div id="menu-overlay"></div>
        <div id="side-menu">
            <div class="menu-header">
                <div class="menu-avatar" id="menu-avatar"></div>
                <div class="menu-user-info">
                    <div class="menu-user-name" id="menu-user-name"></div>
                    <a id="view-profile-btn" class="menu-user-view-profile">View Profile</a>
                </div>
            </div>
            <ul class="menu-nav" id="menu-nav-links">
                <li><a href="#home" class="menu-nav-item" data-page="page-home"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"></path></svg><span>Home</span></a></li>
                <!-- NEW: Live Class menu item -->
                <li><a href="#study" class="menu-nav-item" data-page="page-study"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"></path></svg><span>Live Class</span></a></li>
                <li><a href="#leaderboard" class="menu-nav-item" data-page="page-leaderboard"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 11V3H8v8l4-4 4 4zm-4 10c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"></path></svg><span>Leaderboard</span></a></li>
                <li><a href="#profile" class="menu-nav-item" data-page="page-profile"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg><span>Profile</span></a></li>
                <li><a href="#my-courses" class="menu-nav-item" data-page="page-my-courses"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M4 14h4v-4H4v4zm0 5h4v-4H4v4zM4 9h4V5H4v4zm5 5h12v-4H9v4zm0 5h12v-4H9v4zM9 5v4h12V5H9z"></path></svg><span>My Courses</span></a></li>
                <li><a href="#mcq" class="menu-nav-item" data-page="page-mcq"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"></path></svg><span>MCQ</span></a></li>
                <li><a href="#pdf" class="menu-nav-item" data-page="page-pdf"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zM18 14H13V7h5v7zM4 6H2v14c0 1.1.9 2 2 2h14v-2-H4V6z"></path></svg><span>PDF</span></a></li>
                <li><a href="#test" class="menu-nav-item" data-page="page-test"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14 10H2v2h12v-2zm0-4H2v2h12V6zm4 8v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zM2 16h8v-2H2v2z"></path></svg><span>Test</span></a></li>
                <li><a href="#contact-us" class="menu-nav-item" data-page="page-contact-us"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"></path></svg><span>Contact Us</span></a></li>
                <li><a href="#share" id="share-app-btn" class="menu-nav-item"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"></path></svg><span>Share</span></a></li>
                <li><a href="#about-us" class="menu-nav-item" data-page="page-about-us"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path></svg><span>About Us</span></a></li>
            </ul>
            <div class="menu-footer">
                <button class="btn btn-secondary" id="logout-btn" style="width: 100%;">Logout</button>
                <p class="menu-credit">Made with ❤️ in India</p>
            </div>
        </div>
        <header class="app-header">
            <div class="logo-container">
                <img class="app-logo-img" src="" alt="Logo" style="display: none;">
                <div class="logo">ApnaStudy</div>
            </div>
            <div class="header-actions">
                <button id="notification-btn" class="icon-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"></path></svg><div id="notification-badge"></div></button>
                <div id="header-auth-section"></div>
            </div>
        </header>
        <main>
            <div id="page-home" class="page active">
                 <div class="top-search-bar-container" style="display: flex; align-items: center; gap: 10px; padding: 15px 20px;">
                    <div class="top-search-bar" id="top-search-bar" style="flex-grow: 1;">
                        <div class="search-icon">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
                        </div>
                        <input type="text" placeholder="Search for Courses, Topics..." readonly>
                    </div>
                    <button id="study-btn" class="btn btn-primary" style="padding: 11px 20px; flex-shrink: 0;">Study</button>
                </div>
                <!-- Top Banner (NEW) -->
                <div id="top-banner-wrapper" class="hidden">
                    <!-- Content will be injected by JS -->
                </div>
                <!-- Hero Carousel (Main Banner) -->
                 <div class="hero-carousel-wrapper" id="hero-carousel-wrapper">
                    <div id="hero-carousel-container" class="carousel-container">
                        <div class="carousel-track" id="carousel-track"></div>
                    </div>
                    <div class="carousel-dots" id="carousel-dots"></div>
                </div>
                <!-- Quick Links Section 1 -->
                <div id="quick-links-section-1" class="quick-links-section-wrapper hidden">
                    <div class="quick-links-card">
                        <div class="quick-links-container" id="quick-links-container-1"></div>
                    </div>
                </div>
                <!-- Quick Links Section 2 -->
                <div id="quick-links-section-2" class="quick-links-section-wrapper hidden">
                    <div class="quick-links-card">
                        <div class="quick-links-container" id="quick-links-container-2"></div>
                    </div>
                </div>
                <div id="home-our-batches-container">
                    <h2 class="section-title">Our Batches</h2>
                    <div class="course-grid" id="home-our-batches-grid"></div>
                </div>
                <!-- Mid Page Banner (NEW) -->
                <div id="mid-page-banner-container" class="hidden" style="padding: 0 20px; margin: 25px 0;">
                    <a id="mid-page-banner-link" href="#"></a>
                </div>
                <div id="home-other-batches-container">
                     <h2 class="section-title"><span>Other Batches</span> <a href="#" id="see-more-batches-btn">See more</a></h2>
                     <div class="course-scroll-container" id="home-other-batches-grid"></div>
                </div>
            </div>
            
            <div id="page-study" class="page">
                <header class="detail-header">
                    <button class="back-btn" onclick="AppController.navigateBack()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">Study</h2>
                    <!-- NEW: XP Display in header -->
                    <div id="header-xp-display">
                        <div class="xp-icon">XP</div>
                        <span class="xp-value">0</span>
                    </div>
                </header>
                <div id="study-page-content">
                    <!-- Content will be rendered by JS -->
                </div>
            </div>

            <!-- NEW: Dashboard Page -->
            <div id="page-dashboard" class="page">
                <header class="detail-header">
                    <button class="back-btn" onclick="AppController.navigateBack()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">My Dashboard</h2>
                </header>
                <div id="dashboard-content">
                    <!-- Dashboard cards will be rendered here -->
                </div>
            </div>

            <div id="page-live-class" class="page">
                <header class="detail-header">
                    <button class="back-btn" onclick="AppController.handleLiveClassBack()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">Live Class</h2>
                </header>
                <div id="live-class-content-container">
                    <!-- Live class video and chat will be rendered here -->
                </div>
            </div>

            <div id="page-my-courses" class="page"><h2 class="section-title" style="margin-top:20px;">My Enrolled Courses</h2><div class="course-grid" id="my-courses-grid"></div></div>
            <div id="page-search" class="page"><div class="search-page"><input type="search" id="search-input" class="search-bar" placeholder="Search for any course..."><div class="course-grid" id="search-results-grid"></div></div></div>
            
            <div id="page-profile" class="page">
                 <header class="detail-header">
                    <button class="back-btn" onclick="AppController.navigateBack()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">Settings</h2>
                </header>
                <div id="profile-content"></div>
            </div>

             <div id="page-about-us" class="page"></div>
             <!-- NEW: Contact Us Page Container -->
             <div id="page-contact-us" class="page"></div>
            
            <div id="page-notifications" class="page"></div>
            
            <div id="page-mcq" class="page">
                <header class="detail-header">
                    <button class="back-btn" onclick="AppController.navigateBack()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">MCQ Practice</h2>
                </header>
                <div class="filter-bar-container" id="mcq-filter-container"></div>
                <div id="mcq-container" class="quiz-container"></div>
            </div>
            
            <div id="page-pdf" class="page">
                <header class="detail-header">
                    <button class="back-btn" onclick="AppController.navigateBack()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">PDF Notes</h2>
                </header>
                <div class="filter-bar-container" id="pdf-filter-container"></div>
                <div id="pdf-list-container"></div>
            </div>
            
            <div id="page-test" class="page">
                <header class="detail-header">
                    <button class="back-btn" onclick="AppController.navigateBack()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">Online Tests</h2>
                </header>
                 <div class="filter-bar-container" id="test-filter-container"></div>
                <div id="test-container" class="quiz-container"></div>
            </div>

            <!-- NEW QUIZ RESULT PAGE -->
            <div id="page-quiz-result" class="page">
                <header class="detail-header">
                    <button class="back-btn" id="quiz-result-back-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">Your Progress</h2>
                </header>
                <div id="quiz-result-content-container">
                    <!-- Quiz results will be rendered here by JS -->
                </div>
            </div>

            <!-- NEW QUIZ RANKS PAGE -->
            <div id="page-quiz-ranks" class="page">
                 <header class="detail-header">
                    <button class="back-btn" onclick="AppController.navigateBack()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 id="quiz-ranks-title" class="detail-title">Test Ranks</h2>
                </header>
                <div id="quiz-ranks-container">
                    <!-- Quiz ranks will be rendered here -->
                </div>
            </div>
            
             <div id="page-all-other-batches" class="page">
                <header class="detail-header">
                    <button class="back-btn" onclick="AppController.navigateBack()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">Other Batches</h2>
                </header>
                <div class="course-grid" id="all-other-batches-grid" style="padding-top: 20px;"></div>
            </div>

            <!-- Buy Now Page -->
            <div id="page-buy-now" class="page">
                <header class="detail-header">
                    <button class="back-btn" id="buy-now-back-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">Complete Your Purchase</h2>
                </header>
                <div id="buy-now-content-container"></div>
                <div class="buy-now-footer" id="buy-now-footer-container"></div>
            </div>
            
            <!-- NEW: Payment Gateway Page -->
            <div id="page-payment-gateway" class="page">
                 <header class="detail-header">
                    <button class="back-btn" id="payment-gateway-back-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">Make Payment</h2>
                </header>
                <div id="payment-gateway-content"></div>
            </div>


            <div id="page-leaderboard" class="page">
                <header class="detail-header">
                    <button class="back-btn" onclick="AppController.navigateBack()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title">🏆 Leaderboard</h2>
                </header>

                <div class="leaderboard-level-showcase" id="leaderboard-level-showcase">
                    <div class="level-carousel-track" id="level-carousel-track"></div>
                    <div class="current-level-pillar" id="current-level-pillar"></div>
                </div>

                <div class="leaderboard-zone-container" id="leaderboard-zone-container">
                    <div class="zone-header">
                        <p>Leaderboard updates in <strong>6 days</strong></p>
                        <span style="cursor: pointer; font-size: 1.2rem; opacity: 0.7;">ℹ️</span>
                    </div>
                    <div class="zone-bar-wrapper">
                        <div class="zone-top-labels">
                           <div>Demotion Zone</div>
                           <div>Safety Zone</div>
                           <div>Promotion Zone</div>
                        </div>
                        <div class="zone-bar">
                            <div class="zone-bar-segment zone-demotion-bar"></div>
                            <div class="zone-bar-segment zone-safety-bar"></div>
                            <div class="zone-bar-segment zone-promotion-bar"></div>
                        </div>
                         <div class="zone-bottom-labels">
                            <span>Ranks 30-27</span>
                            <span>Ranks 26-15</span>
                            <span>Ranks 14-1</span>
                        </div>
                        <div class="user-rank-indicator" id="user-rank-indicator">
                            <div class="user-rank-box">Rank: ?</div>
                            <div class="user-rank-arrow"></div>
                        </div>
                    </div>
                </div>
                
                <div id="leaderboard-container"></div>
            </div>

            <div id="page-course-contents" class="page">
                <header class="detail-header"><button class="back-btn" id="course-contents-back-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg></button><h2 id="course-contents-title" class="detail-title">Subjects</h2></header>
                <div style="padding: 20px;" id="subjects-list-container"></div>
            </div>
            <div id="page-chapters" class="page">
                <header class="detail-header"><button class="back-btn" id="chapters-back-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg></button><h2 id="chapters-title" class="detail-title">Chapters</h2></header>
                <div style="padding: 20px;" id="chapters-list-container"></div>
            </div>
            <div id="page-lectures" class="page">
                <header class="detail-header">
                    <button class="back-btn" id="lectures-back-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg></button>
                    <h2 id="lectures-title" class="detail-title">Lectures</h2>
                </header>
                <div id="lectures-list-container"></div>
            </div>
            
            <div id="page-video-player" class="page">
                <header class="detail-header">
                    <button class="back-btn" id="video-player-back-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title" id="video-header-title">Lecture Video</h2>
                </header>
                <div class="video-wrapper">
                    <video id="video-player-element" webkit-playsinline playsinline controls style="display: none;"></video>
                    <div id="iframe-player-container" style="width:100%; height:100%; display: none;"></div>
                </div>
                <div class="video-content-container">
                    <div class="video-actions-container">
                        <h2 id="video-player-title">Video Title Here</h2>
                        <div class="video-actions-scroll">
                            <div id="video-comments-btn" class="action-circle">
                                <div class="action-icon-wrapper"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg></div>
                                <span>Comments</span>
                            </div>
                            <div id="video-ask-question-btn" class="action-circle">
                                <div class="action-icon-wrapper"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-4h2v-6h-2v6z"></path></svg></div>
                                <span>Ask Question</span>
                            </div>
                            <div id="video-pdf-btn" class="action-circle hidden pdf-viewer-btn">
                                <div class="action-icon-wrapper"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zM18 14H13V7h5v7zM4 6H2v14c0 1.1.9 2 2 2h14v-2-H4V6z"></path></svg></div>
                                <span>View PDF</span>
                            </div>
                            <a href="#" id="video-download-btn" class="action-circle download-btn" download>
                                <div class="action-icon-wrapper"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"></path></svg></div>
                                <span>Download</span>
                            </a>
                        </div>
                        <form id="video-input-form" class="video-input-bar hidden">
                            <textarea id="video-input" rows="1" required></textarea>
                            <button type="submit" class="btn btn-primary">
                                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                            </button>
                        </form>
                    </div>
                    
                    <div class="video-content-section">
                        <div id="comment-section" class="comment-section">
                            <div id="comment-list" class="comment-list"></div>
                        </div>
                        <div id="ask-question-section" class="ask-question-section hidden">
                            <div id="question-list" class="question-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PDF Viewer Page -->
            <div id="page-pdf-viewer" class="page">
                 <header class="detail-header">
                    <button class="back-btn" id="pdf-viewer-back-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                    </button>
                    <h2 class="detail-title" id="pdf-viewer-title">PDF Document</h2>
                    <div class="detail-header-actions">
                        <button id="pdf-options-btn" class="icon-btn">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                        </button>
                        <div id="pdf-dropdown-menu" class="dropdown-menu">
                            <a href="#" id="pdf-download-link" class="dropdown-item" download>Download PDF</a>
                        </div>
                    </div>
                </header>
                <div class="pdf-viewer-container">
                    <iframe id="pdf-viewer-iframe" class="pdf-viewer-iframe" frameborder="0"></iframe>
                </div>
            </div>

        </main>
        
        <nav class="bottom-nav">
            <a href="#home" class="nav-item active" data-page="page-home"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"></path></svg><span>Home</span></a>
            <a href="#my-courses" class="nav-item" data-page="page-my-courses"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 14h4v-4H4v4zm0 5h4v-4H4v4zM4 9h4V5H4v4zm5 5h12v-4H9v4zm0 5h12v-4H9v4zM9 5v4h12V5H9z"></path></svg><span>My Courses</span></a>
            <a href="#search" class="nav-item" data-page="page-search"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg><span>Search</span></a>
            <a href="#profile" class="nav-item" data-page="page-profile"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41h-3.84 c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.48c-0.59,0.24-1.13,0.57-1.62,0.94l-2.39-0.96c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.97 C2.62,9.18,2.67,9.44,2.85,9.58l2.03,1.58C4.84,11.4,4.82,11.7,4.82,12s0.02,0.6,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39,0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.67 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.67c0.59-0.24,1.13-0.57,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.5c-1.93,0-3.5-1.57-3.5-3.5 s1.57-3.5,3.5-3.5s3.5,1.57,3.5,3.5S13.93,15.5,12,15.5z" ></path></svg><span>Settings</span></a>
        </nav>
        <div id="modal-container"></div>
        <div id="detail-page" class="detail-page-container"><header class="detail-header"><button class="back-btn" id="detail-back-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg></button><h2 id="detail-title" class="detail-title"></h2></header><div id="detail-content" class="detail-content"></div><div id="detail-footer" class="detail-footer"></div></div>
    </div>

    <!-- NEW: Image Viewer Modal -->
    <div id="image-viewer-modal" style="display: none;">
        <span id="image-viewer-close">×</span>
        <div class="image-viewer-content">
            <img id="image-viewer-img" src="" alt="Zoomed Image">
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDJitQrBXpT4nnG1uBDrgBhRf05JNrO0yI",
        authDomain: "apna-study-apna-group.firebaseapp.com",
        databaseURL: "https://apna-study-apna-group-default-rtdb.firebaseio.com",
        projectId: "apna-study-apna-group",
        storageBucket: "apna-study-apna-group.appspot.com",
        messagingSenderId: "875071837925",
        appId: "1:875071837925:web:101e87217ca8c39fb6a60c"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    document.addEventListener('DOMContentLoaded', () => {
        const AppState = {
            data: { courses: null, settings: {}, mcqs: [], tests: [], pdfs: [], leaderboard: [], schedules: {} },
            session: { currentUser: null, userData: null },
            ui: {
                mainCarousel: { state: null, slide: 0, timer: null, wasDragged: false },
                navigationHistory: [], filters: {},
                currentVideoItem: null, videoPlayerMode: 'comments', controlsTimeout: null, xpInterval: null,
                commentsToShow: 5, questionsToShow: 5,
                selectedStudyBatchId: null,
                liveStatusInterval: null,
                currentLiveSchedule: null
            },
            quiz: { type: null, questions: [], currentIndex: 0, userAnswers: {}, isSubmitted: {}, source: null, id: null, title: null }
        };

        const UI = {
            renderCourseCard(course) {
                const user = AppState.session.userData;
                const isEnrolled = user?.enrolledCourses?.[course.id];
                let priceHtml = '';
                let buttonsHtml = '';

                if (isEnrolled) {
                    buttonsHtml = `<button class="btn btn-secondary lets-study-btn" data-id="${course.id}">Let's Study</button>`;
                } else if (course.type === 'free') {
                    priceHtml = `<div class="price-container"><span class="price free">Free</span></div>`;
                    buttonsHtml = `<div class="card-buttons"><button class="btn btn-secondary explore-btn" data-id="${course.id}">EXPLORE</button><button class="btn btn-primary enroll-btn" data-id="${course.id}">Enroll Free</button></div>`;
                } else {
                    const price = parseFloat(course.price);
                    const originalPrice = parseFloat(course.originalPrice);
                    let discountPercentage = 0;

                    if (originalPrice && price < originalPrice) {
                        discountPercentage = Math.round(((originalPrice - price) / originalPrice) * 100);
                        priceHtml = `
                            <div class="price-container">
                                <span class="price">₹${price.toLocaleString('en-IN')}</span>
                                <span class="original-price">₹${originalPrice.toLocaleString('en-IN')}</span>
                                <div class="discount-tag">${discountPercentage}% Discount Applied</div>
                            </div>`;
                    } else {
                        priceHtml = `<div class="price-container"><span class="price">₹${price.toLocaleString('en-IN')}</span></div>`;
                    }
                    buttonsHtml = `<div class="card-buttons"><button class="btn btn-secondary explore-btn" data-id="${course.id}">EXPLORE</button><button class="btn btn-primary buy-now-btn" data-id="${course.id}">BUY NOW</button></div>`;
                }
                
                return `
                <div class="course-card" data-id="${course.id}">
                    <div class="course-card-clickable-area">
                        <div class="course-thumbnail"><img src="${course.thumbnail}" alt="${course.title}"></div>
                        <div class="course-card-content"><h3>${course.title}</h3><p>${course.description}</p></div>
                    </div>
                    <div class="card-footer">
                        <div class="card-divider"></div>
                        ${priceHtml}
                        ${buttonsHtml}
                    </div>
                </div>`;
            },
            renderCourses(containerId, list, emptyMsg) { const c = document.getElementById(containerId); if (!list || list.length === 0) { c.innerHTML = `<div class="empty-state">${emptyMsg}</div>`; return; } c.innerHTML = list.map(UI.renderCourseCard).join(''); },
            updateHeader() { const h = document.getElementById('header-auth-section'); if (AppState.session.currentUser) { h.innerHTML = `<button id="menu-btn" class="icon-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button>`; } },
            updateMenuHeader() {
                if (AppState.session.userData) {
                    const name = AppState.session.userData.name || 'User';
                    const avatarDiv = document.getElementById('menu-avatar');
                    const profileUrl = AppState.session.userData.profileImageUrl;

                    if (profileUrl) {
                        avatarDiv.innerHTML = `<img src="${profileUrl}" alt="Profile">`;
                    } else {
                        const initial = (name ? name.charAt(0) : '?').toUpperCase();
                        avatarDiv.textContent = initial;
                        avatarDiv.innerHTML = initial;
                    }
                    document.getElementById('menu-user-name').textContent = name;
                }
            },
            applySettings() {
                const userSettings = AppState.session.userData?.settings;
                const globalSettings = AppState.data.settings || {};
                let useDarkMode = globalSettings.darkMode || false;
                
                if (AppState.session.userData && userSettings && typeof userSettings.darkMode === 'boolean') {
                    useDarkMode = userSettings.darkMode;
                }

                const newTheme = useDarkMode ? 'dark' : 'light';
                if (document.documentElement.dataset.theme !== newTheme) {
                    document.documentElement.dataset.theme = newTheme;
                }
                
                const darkModeToggle = document.getElementById('dark-mode-toggle');
                if (darkModeToggle) {
                    darkModeToggle.checked = useDarkMode;
                }

                this.updateAppBranding(globalSettings);
                this.renderTopBanner(globalSettings.topBanner); 
                this.renderBanners(globalSettings.banners);
                this.renderQuickLinks(globalSettings.quickLinks1, 1);
                this.renderQuickLinks(globalSettings.quickLinks2, 2);
                this.renderMidPageBanner(globalSettings.midPageBanner);
            },
            updateAppBranding(settings) {
                const appName = settings.appName || 'ApnaStudy';
                document.querySelectorAll('.logo, .splash-logo').forEach(el => el.textContent = appName);

                const logoImgs = document.querySelectorAll('.app-logo-img');
                if (settings.logoUrl && logoImgs.length > 0) {
                    logoImgs.forEach(img => {
                        img.src = settings.logoUrl;
                        img.style.display = 'block';
                    });
                } else if (logoImgs.length > 0) {
                    logoImgs.forEach(img => {
                        img.style.display = 'none';
                    });
                }
            },
            renderTopBanner(bannerData) {
                const wrapper = document.getElementById('top-banner-wrapper');
                if (!bannerData || !bannerData.url) {
                    wrapper.classList.add('hidden');
                    wrapper.innerHTML = '';
                    return;
                }
                wrapper.classList.remove('hidden');

                const type = bannerData.type || 'image';
                let mediaHtml = '';
                if (type === 'video') {
                    mediaHtml = `<video src="${bannerData.url}" muted playsinline autoplay loop></video>`;
                } else {
                    mediaHtml = `<img src="${bannerData.url}" alt="Top Banner">`;
                }
                
                const linkUrl = bannerData.courseId ? `#` : (bannerData.linkUrl || '#');
                const courseIdAttr = bannerData.courseId ? `data-course-id="${bannerData.courseId}"` : '';
                const targetAttr = bannerData.linkUrl && !bannerData.courseId ? `target="_blank"`: '';

                wrapper.innerHTML = `<a href="${linkUrl}" ${targetAttr} ${courseIdAttr}>${mediaHtml}</a>`;
            },
            renderBanners(banners) {
                const wrapper = document.getElementById('hero-carousel-wrapper');
                const track = document.getElementById('carousel-track');
                const dotsContainer = document.getElementById('carousel-dots');
                const bannerList = banners ? Object.values(banners) : [];

                if (bannerList.length === 0) {
                    wrapper.classList.add('hidden');
                    return;
                }
                wrapper.classList.remove('hidden');
                
                track.innerHTML = bannerList.map(b => {
                    const type = b.type || 'image';
                    let mediaHtml = '';
                    if (type === 'video') {
                        mediaHtml = `<video src="${b.imageUrl || b.mediaUrl}" muted playsinline></video>`;
                    } else {
                        mediaHtml = `<img src="${b.imageUrl || b.mediaUrl}" alt="Banner">`;
                    }
                    return `<div class="carousel-slide" data-type="${type}" data-course-id="${b.courseId || ''}">${mediaHtml}</div>`;
                }).join('');

                dotsContainer.innerHTML = bannerList.map((_, index) => `<div class="dot" data-slide-index="${index}"></div>`).join('');
                AppController.startMainCarousel(bannerList.length);
            },
            renderMidPageBanner(bannerData) {
                const container = document.getElementById('mid-page-banner-container');
                const link = document.getElementById('mid-page-banner-link');
                if (!container || !link || !bannerData || !bannerData.url) {
                    container?.classList.add('hidden');
                    return;
                }
                
                link.innerHTML = ''; // Clear previous content

                if (bannerData.type === 'video') {
                    const video = document.createElement('video');
                    video.src = bannerData.url;
                    video.autoplay = true;
                    video.loop = true;
                    video.muted = true;
                    video.setAttribute('playsinline', '');
                    video.style.width = '100%';
                    video.style.display = 'block';
                    video.style.borderRadius = 'var(--border-radius)';
                    link.appendChild(video);
                } else { // Default to image/gif
                    const img = document.createElement('img');
                    img.src = bannerData.url;
                    img.style.width = '100%';
                    img.style.display = 'block';
                    img.style.borderRadius = 'var(--border-radius)';
                    link.appendChild(img);
                }

                if (bannerData.linkUrl) {
                    link.href = bannerData.linkUrl;
                    link.target = '_blank';
                } else {
                    link.href = '#';
                    link.onclick = (e) => e.preventDefault();
                }
                
                container.classList.remove('hidden');
            },
            renderQuickLinks(quickLinks, sectionNumber) {
                const section = document.getElementById(`quick-links-section-${sectionNumber}`);
                const container = document.getElementById(`quick-links-container-${sectionNumber}`);
                const linkList = quickLinks ? Object.values(quickLinks) : [];

                if (!section || !container) return;

                if (linkList.length === 0) {
                    section.classList.add('hidden');
                    return;
                }
                section.classList.remove('hidden');

                container.innerHTML = linkList.map(link => {
                    const iconContent = link.iconUrl
                        ? `<img src="${link.iconUrl}" alt="${link.name}">`
                        : `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>`;

                    return `
                    <a href="#" class="quick-link-item" data-page="${link.targetPage || 'page-home'}">
                        <div class="quick-link-icon">${iconContent}</div>
                        <span>${link.name}</span>
                    </a>`;
                }).join('');
            },
            showModal(title, content, isCancellable = true) { const modalId = 'modal-' + Date.now(); const m = `<div class="modal-overlay visible" id="${modalId}"><div class="modal-content"><div class="modal-header"><h2>${title}</h2>${isCancellable ? `<button class="modal-close" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">×</button>` : ''}</div>${content}</div></div>`; document.getElementById('modal-container').innerHTML = m; const c = () => document.getElementById(modalId)?.remove(); if (isCancellable) { document.querySelector(`#${modalId} .modal-close`).addEventListener('click', c); document.getElementById(modalId).addEventListener('click', e => { if (e.target === e.currentTarget) c(); }); } },
            showConfirmationModal(title, message, confirmText = 'OK', cancelText = 'Cancel') {
                return new Promise((resolve) => {
                    const content = `
                        <p>${message}</p>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel-btn">${cancelText}</button>
                            <button class="btn btn-danger" id="modal-confirm-btn">${confirmText}</button>
                        </div>
                    `;
                    this.showModal(title, content, true);

                    const modalContainer = document.querySelector('.modal-overlay');
                    const confirmBtn = document.getElementById('modal-confirm-btn');
                    const cancelBtn = document.getElementById('modal-cancel-btn');

                    const close = (result) => {
                        modalContainer.remove();
                        resolve(result);
                    };

                    confirmBtn.onclick = () => close(true);
                    cancelBtn.onclick = () => close(false);
                    modalContainer.querySelector('.modal-close').onclick = () => close(false);
                    modalContainer.onclick = (e) => { if (e.target === e.currentTarget) close(false); }
                });
            },
            showDetailPage(course) { const d = document.getElementById('detail-page'); document.getElementById('detail-title').textContent = course.title; const isEnrolled = AppState.session.userData?.enrolledCourses?.[course.id]; let btn = ''; if (isEnrolled) { btn = `<button class="btn btn-secondary lets-study-btn" data-id="${course.id}">Let's Study</button>`; } else if (course.type === 'free') { btn = `<button class="btn btn-primary enroll-btn" data-id="${course.id}">Enroll Free</button>`; } else { btn = `<button class="btn btn-primary buy-now-btn" data-id="${course.id}">Buy Now</button>`; } document.getElementById('detail-content').innerHTML = `<img src="${course.thumbnail}" alt="${course.title}"><p class="detail-description">${course.description}</p>`; document.getElementById('detail-footer').innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><span class="price ${course.type}" style="font-size:1.4rem;">${course.type === 'free' ? 'Free' : `₹${course.price}`}</span>${btn}</div>`; d.classList.add('visible'); },
            hideDetailPage() { document.getElementById('detail-page').classList.remove('visible'); },
            renderPdfs(list) {
                const container = document.getElementById('pdf-list-container');
                const currentFilter = AppState.ui.filters.pdf || 'all';
                let filteredList = list;
                if (currentFilter !== 'all') {
                    filteredList = list.filter(item => item.class == currentFilter);
                }

                if (!filteredList || filteredList.length === 0) {
                    container.innerHTML = `<div class="empty-state">No PDFs found for the selected filter.</div>`;
                    return;
                }
                container.innerHTML = `<div class="pdf-list">${filteredList.map(pdf => {
                    // REMOVED: isDownloaded check from localStorage
                    return `
                    <div class="pdf-item">
                        <div class="pdf-item-info">
                            <h4>${pdf.title}</h4>
                            <p>Class: ${pdf.class || 'N/A'} • Subject: ${pdf.subject || 'N/A'}</p>
                        </div>
                        <div class="pdf-item-actions">
                            <button class="btn btn-secondary pdf-viewer-btn" data-url="${pdf.url}" data-title="${pdf.title}">View</button>
                            <a href="${pdf.url}" download="${pdf.title}.pdf" class="btn btn-primary download-btn" data-item='${JSON.stringify(pdf)}'>
                                Download
                            </a>
                        </div>
                    </div>`
                }).join('')}
                </div>`;
            },
            renderCourseSubjects(course) {
                document.getElementById('course-contents-title').textContent = course.title;
                const container = document.getElementById('subjects-list-container');
                const subjects = AppController.firebaseObjectToArray(course.subjects);
                if (!subjects || subjects.length === 0) { container.innerHTML = `<div class="empty-state">No subjects found for this course.</div>`; return; }
                container.innerHTML = subjects.map(subject => {
                    const logoContent = subject.thumbnailUrl
                        ? `<img src="${subject.thumbnailUrl}" alt="${subject.title || 'Logo'}">`
                        : (subject.title ? subject.title.charAt(0).toUpperCase() : '?');

                    return `
                    <div class="subject-accordion-item" data-course-id="${course.id}" data-subject-id="${subject.id}" data-subject-title="${subject.title}">
                        <div class="subject-header">
                            <div class="subject-logo">${logoContent}</div>
                            <span class="subject-title">${subject.title || 'Untitled Subject'}</span>
                            <div class="subject-arrow">
                                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 17l5-5-5-5v10z"></path></svg>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },
            renderBuyNowPage(course) {
                const contentContainer = document.getElementById('buy-now-content-container');
                const footerContainer = document.getElementById('buy-now-footer-container');

                const price = parseFloat(course.price);
                const originalPrice = parseFloat(course.originalPrice) || price;
                const discountAmount = originalPrice - price;
                const discountPercentage = originalPrice > 0 ? Math.round((discountAmount / originalPrice) * 100) : 0;
                
                const points = (course.points && course.points.length > 0) ? course.points : [
                    "Chapter-wise Video & Live Lectures",
                    "Downloadable PDF Notes",
                    "MCQ Practice Questions",
                    "Weekly & Monthly Tests",
                    "Live Doubt-Solving Sessions",
                    "Complete Syllabus Coverage"
                ];

                 const pointsHtml = points.map(point => {
                    return `<li><svg viewBox="0 0 24 24" fill="currentColor" style="width:20px; height:20px; color:var(--success-color); position:absolute; left:0; top:2px;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path></svg>${point}</li>`;
                 }).join('');

                const contentHtml = `
                    <div class="buy-now-wrapper">
                        <div class="buy-now-thumbnail">
                            <img src="${course.thumbnail}" alt="${course.title}">
                        </div>
                        <h3 class="buy-now-title">${course.title}</h3>
                        
                        <h4 class="section-title" style="margin: 20px 0 15px 0; text-align: left; display: block;">📚 What You Will Get in This Course</h4>
                        <ul class="buy-now-points">${pointsHtml}</ul>

                        <div class="payment-details-card">
                            <h4>Payment Details</h4>
                            <div class="payment-row">
                                <span>Batch Price</span>
                                <span>₹${originalPrice.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</span>
                            </div>
                            ${discountAmount > 0 ? `
                            <div class="payment-row" style="color: var(--success-color);">
                                <span>Item Discount</span>
                                <span>-₹${discountAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</span>
                            </div>` : ''}
                            <div class="payment-row total">
                                <span>Total Amount</span>
                                <span>₹${price.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</span>
                            </div>
                        </div>
                    </div>`;
                
                const footerHtml = `
                    <button class="btn btn-primary proceed-btn" data-id="${course.id}">
                        PROCEED TO PAY ₹${price.toLocaleString('en-IN')}
                    </button>`;

                contentContainer.innerHTML = contentHtml;
                footerContainer.innerHTML = footerHtml;
            },
            renderChapters(courseId, subjectId, subjectTitle) {
                document.getElementById('chapters-title').textContent = subjectTitle;
                const container = document.getElementById('chapters-list-container');
                container.innerHTML = `<div class="empty-state">Loading chapters...</div>`;
                db.ref(`courses/${courseId}/subjects/${subjectId}/chapters`).on('value', snapshot => {
                    const chapters = AppController.firebaseObjectToArray(snapshot.val());
                    if (!chapters || chapters.length === 0) { container.innerHTML = `<div class="empty-state">No chapters found in this subject.</div>`; return; }
                    container.innerHTML = chapters.map((chapter, index) => { const contentCount = chapter.content ? Object.keys(chapter.content).length : 0; return ` <div class="chapter-card" data-course-id="${courseId}" data-subject-id="${subjectId}" data-chapter-id="${chapter.id}" data-chapter-title="${chapter.title}"> <div class="chapter-info"> <h4>Chapter ${index + 1}: ${chapter.title}</h4> <p>Contents: ${contentCount}</p> </div> <div class="chapter-arrow"> <svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 17l5-5-5-5v10z"></path></svg> </div> </div>`; }).join('');
                });
            },
            renderLectures(courseId, subjectId, chapterId, chapterTitle) {
                document.getElementById('lectures-title').textContent = chapterTitle;
                const container = document.getElementById('lectures-list-container');
                container.innerHTML = `
                    <div class="filter-container">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="video">Lectures</button>
                        <button class="filter-btn" data-filter="pdf">PDFs</button>
                        <button class="filter-btn" data-filter="test">Tests</button> 
                    </div>
                    <div class="lecture-content-list"><div class="empty-state">Loading content...</div></div>`;

                db.ref(`courses/${courseId}/subjects/${subjectId}/chapters/${chapterId}/content`).orderByChild('timestamp').on('value', snapshot => {
                    const contentList = AppController.firebaseObjectToArray(snapshot.val()).reverse();
                    const listContainer = container.querySelector('.lecture-content-list');
                    if (!contentList || contentList.length === 0) { listContainer.innerHTML = `<div class="empty-state">No content found in this chapter.</div>`; return; }
                    
                    const completedLectures = AppState.session.userData.completedLectures || {};
                    
                    listContainer.innerHTML = contentList.map(item => {
                        
                        if (item.type === 'test') {
                            const testIcon = `<svg viewBox="0 0 24 24" fill="currentColor" style="width: 40px; height: 40px; color: var(--primary-color);"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 9H9v2h4v-2zm-1 4h-4v2h4v-2z"></path></svg>`;
                            return `
                            <div class="content-card-wrapper" data-type="test" data-item='${JSON.stringify(item)}' data-id="${item.id}">
                                <div class="content-card">
                                    <div class="content-card-main">
                                        <div class="content-thumbnail" style="display:flex; align-items:center; justify-content:center; background: #f0f4ff;">${testIcon}</div>
                                        <div class="content-details">
                                            <p class="content-meta">TEST • ${item.date || 'N/A'}</p>
                                            <h4 class="content-title">${item.title}</h4>
                                            <div class="content-actions">
                                                <button class="content-action-btn watch start-course-test-btn">
                                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>
                                                    Start Test
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        }

                        // --- Video and PDF rendering logic ---
                        const isCompleted = completedLectures[item.id];
                        
                        let mainThumbnailHtml = '';
                        const defaultIcon = item.type === 'pdf'
                            ? `<svg viewBox="0 0 24 24" fill="currentColor" style="width: 40px; height: 40px; color: #888;"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zM18 14H13V7h5v7zM4 6H2v14c0 1.1.9 2 2 2h14v-2-H4V6z"></path></svg>`
                            : `<svg viewBox="0 0 24 24" fill="currentColor" style="width: 40px; height: 40px; color: #888;"><path d="M8 5v14l11-7z"></path></svg>`;

                        if (item.thumbnail) {
                            mainThumbnailHtml = `<div class="content-thumbnail"><img src="${item.thumbnail}" alt="thumbnail">${item.duration ? `<div class="content-time-overlay">${item.duration}</div>` : ''}</div>`;
                        } else {
                            mainThumbnailHtml = `<div class="content-thumbnail" style="display:flex; align-items:center; justify-content:center;">${defaultIcon}</div>`;
                        }
                        
                        const completionButtonHtml = item.type === 'video' ? `<div class="content-complete-btn ${isCompleted ? 'completed' : ''}" data-lecture-id="${item.id}" title="Status">${isCompleted ? '✔' : ''}</div>` : '';
                        
                        const watchAction = item.type === 'video'
                            ? `<button class="content-action-btn watch video-watch-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg> Watch</button>`
                            : `<button class="content-action-btn watch pdf-viewer-btn" data-url="${item.url}" data-title="${item.title}"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 14h-2v-2h2v2zm0-4h-2v-2h2v2zm-4-4h-2V6h2v2z"></path></svg> View PDF</button>`;

                        const downloadFilename = item.type === 'video' ? `${item.title}.mp4` : `${item.title}.pdf`;
                        // REMOVED: isDownloaded check and class
                        const downloadAction = `<a href="${item.url}" download="${downloadFilename}" class="content-action-btn icon download-btn" title="Download" data-item='${JSON.stringify(item)}'><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"></path></svg></a>`;
                        const notesAction = item.notesUrl ? `<button class="content-action-btn icon pdf-viewer-btn" title="View Notes" data-url="${item.notesUrl}" data-title="Notes: ${item.title}"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 14h-2v-2h2v2zm0-4h-2v-2h2v2zm-4-4h-2V6h2v2z"></path></svg></button>` : '';
                        
                        return `
                        <div class="content-card-wrapper" data-type="${item.type}" data-item='${JSON.stringify(item)}'>
                            <div class="content-card">
                                <div class="content-card-main">
                                    ${mainThumbnailHtml}
                                    <div class="content-details">
                                        <p class="content-meta">${item.type.toUpperCase()} • ${item.date || 'N/A'}</p>
                                        <h4 class="content-title">${item.title}</h4>
                                        <div class="content-actions">
                                            ${watchAction}
                                            ${downloadAction}
                                            ${notesAction}
                                        </div>
                                    </div>
                                </div>
                                ${completionButtonHtml}
                            </div>
                        </div>`;
                    }).join('');
                });
                
                container.querySelector('.filter-container').addEventListener('click', e => {
                    if (e.target.classList.contains('filter-btn')) {
                        container.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        const filter = e.target.dataset.filter;
                        container.querySelectorAll('.content-card-wrapper').forEach(card => {
                            card.style.display = (filter === 'all' || card.dataset.type === filter) ? 'block' : 'none';
                        });
                    }
                });
            },
            updateNotificationIcon() {
                const badge = document.getElementById('notification-badge');
                const notifications = AppController.firebaseObjectToArray(AppState.data.settings.notifications);
                const lastChecked = AppState.session.userData?.notificationsLastChecked || 0;
                
                const hasUnread = notifications.some(n => n.timestamp > lastChecked);

                if (hasUnread) {
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            },
            renderNotificationsPage() {
                const container = document.getElementById('page-notifications');
                const notificationsObj = AppState.data.settings.notifications;
                let content = '';

                if (notificationsObj) {
                    const notificationList = AppController.firebaseObjectToArray(notificationsObj).sort((a, b) => b.timestamp - a.timestamp);
                    
                    content = `<div style="padding: 15px;">${notificationList.map(n => {
                        const imageHtml = n.imageUrl ? `<img src="${n.imageUrl}" style="width: 100%; max-width: 100%; border-radius: 8px; margin-top: 15px;">` : '';
                        const linkHtml = n.linkUrl ? `<div style="margin-top: 10px;"><a href="${n.linkUrl}" target="_blank" class="notification-link">${n.linkUrl}</a></div>` : '';
                        
                        return `
                        <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: var(--shadow);">
                            <p>${n.text}</p>
                            ${linkHtml}
                            ${imageHtml}
                            <small style="display: block; text-align: right; opacity: 0.7; margin-top: 10px;">${AppController.formatTimeAgo(n.timestamp)}</small>
                        </div>`;
                    }).join('')}</div>`;
                } else {
                    content = `<div class="empty-state">No notifications right now.</div>`;
                }
                
                container.innerHTML = `
                    <header class="detail-header">
                        <button class="back-btn" onclick="AppController.navigateBack()">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                        </button>
                        <h2 class="detail-title">Notifications</h2>
                    </header>
                    ${content}
                `;
            },
            renderQuizList(type) {
                const containerId = `${type}-container`;
                const container = document.getElementById(containerId);
                let data = type === 'mcq' ? AppState.data.mcqs : AppState.data.tests;
                const currentFilter = AppState.ui.filters[type] || 'all';

                if (currentFilter !== 'all') {
                    data = data.filter(item => item.class == currentFilter);
                }

                if (!data || data.length === 0) {
                    container.innerHTML = `<div class="empty-state">No ${type.toUpperCase()} sets found for the selected filter.</div>`;
                    return;
                }
                container.innerHTML = data.map(set => ` <div class="quiz-list-item" onclick="AppController.startQuiz('${type}', '${set.id}')"> <div> <h4>${set.title}</h4> <p style="font-size:0.9rem; opacity:0.7;">${set.subject} | Class ${set.class}</p> </div> <button class="btn btn-primary">Start</button> </div>`).join('');
            },
            renderQuiz() { 
                const { type } = AppState.quiz;
                const filterContainer = document.getElementById(`${type}-filter-container`);
                if(filterContainer) filterContainer.style.display = 'none';

                const { questions, currentIndex, userAnswers, isSubmitted } = AppState.quiz; 
                const container = document.getElementById(`${type}-container`); 
                if (!questions || questions.length === 0) { 
                    container.innerHTML = `<div class="empty-state">This set has no questions.</div><button class="btn btn-secondary" onclick="AppController.loadPageContent('page-${type}')">Go Back</button>`; return; 
                } 
                const q = questions[currentIndex]; 
                const questionKey = currentIndex; 
                const optionsHtml = Object.values(q.options).map(optionText => { 
                    let optClass = 'quiz-option'; 
                    if (isSubmitted[questionKey]) { 
                        if (optionText === q.options[q.answer]) {
                            optClass += ' correct'; 
                        } else if (optionText === userAnswers[questionKey]) {
                            optClass += ' incorrect'; 
                        }
                    } else if (optionText === userAnswers[questionKey]) { 
                        optClass += ' selected'; 
                    } 
                    return `<li class="${optClass}" data-option="${optionText}">${optionText}</li>`; 
                }).join(''); 
                
                container.innerHTML = `
                    <div class="quiz-question-card">
                        <p style="opacity: 0.8; margin-bottom: 10px;">Question ${currentIndex + 1} of ${questions.length}</p>
                        <h3 class="quiz-question-text">${q.question}</h3>
                        <ul class="quiz-options">${optionsHtml}</ul>
                    </div>
                    <div id="quiz-feedback" class="empty-state" style="padding:10px 20px; font-weight: bold; min-height: 24px;">
                        ${isSubmitted[questionKey] && userAnswers[questionKey] !== q.options[q.answer] ? `Correct Answer: ${q.options[q.answer]}` : ''}
                    </div>
                    <button class="btn btn-primary" id="quiz-submit-btn" style="width:100%;" ${isSubmitted[questionKey] ? 'disabled' : ''}>Submit</button>
                    <div class="quiz-navigation">
                        <button class="btn btn-secondary" id="quiz-prev-btn" ${currentIndex === 0 ? 'disabled' : ''}>Previous</button>
                        ${currentIndex === questions.length - 1 ? `<button class="btn btn-primary" id="quiz-finish-btn">Finish</button>` : `<button class="btn btn-primary" id="quiz-next-btn">Next</button>`}
                    </div>`; 
            },
            renderQuizResult() {
                const { type, questions, userAnswers } = AppState.quiz;
                let correctAnswers = 0;
                questions.forEach((q, index) => { 
                    if (userAnswers[index] === q.options[q.answer]) correctAnswers++; 
                });

                const totalQuestions = questions.length;
                const incorrectAnswers = totalQuestions - correctAnswers;
                
                const xpGained = correctAnswers * 2;
                if (xpGained > 0 && AppState.session.currentUser) {
                    AppController.updateUserXP(xpGained);
                }

                // Store the result for ranking
                if (AppState.session.currentUser) {
                    const resultData = {
                        userId: AppState.session.currentUser.uid,
                        userName: (AppState.session.userData.name || 'Anonymous User'), // MODIFIED: Added fallback
                        score: correctAnswers,
                        total: totalQuestions,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    db.ref(`quizResults/${AppState.quiz.id}/${AppState.session.currentUser.uid}`).set(resultData);
                }

                const correctPercentage = totalQuestions > 0 ? (correctAnswers / totalQuestions) * 100 : 0;
                const incorrectPercentage = 100 - correctPercentage;
                
                let feedback = {};
                if (correctPercentage >= 80) { feedback = { text: "Excellent!", emoji: "🎉" }; } 
                else if (correctPercentage >= 50) { feedback = { text: "Good Job!", emoji: "👍" }; } 
                else { feedback = { text: "Keep Practicing!", emoji: "💪" }; }

                const container = document.getElementById('quiz-result-content-container');
                const xpMessageHtml = xpGained > 0 ? `<p id="xp-gain-message" style="margin-top: 10px; font-weight: 600; color: var(--xp-color); text-align: center; transition: all 0.5s ease; overflow: hidden; max-height: 50px; padding: 5px 0;">+${xpGained} XP Earned!</p>` : '';
                
                let backButtonAction;
                if (AppState.quiz.source === 'course') {
                    backButtonAction = `AppController.navigateBack()`;
                } else {
                    backButtonAction = `AppController.navigateToPage('page-${type}')`;
                }

                container.innerHTML = `
                <div class="quiz-result-header">
                    <h2 class="quiz-result-title">Your Progress</h2>
                    <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px" fill="var(--primary-color)"><path d="M0 0h24v24H0V0z" fill="none"></path><path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z"></path></svg>
                </div>

                <div class="quiz-result-card-new score-card">
                    <span class="score-label">SCORE</span>
                    <span class="score-value">${correctAnswers}/${totalQuestions}</span>
                </div>

                <div class="quiz-result-card-new details-card">
                    <div class="progress-item">
                        <div class="progress-header">
                            <span>✔ Correct</span>
                            <span class="progress-value">${correctPercentage.toFixed(0)}%</span>
                        </div>
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar correct" style="width: ${correctPercentage}%"></div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-header">
                            <span>✖ Incorrect</span>
                            <span class="progress-value">${incorrectPercentage.toFixed(0)}%</span>
                        </div>
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar incorrect" style="width: ${incorrectPercentage}%"></div>
                        </div>
                    </div>
                </div>

                <div class="quiz-result-card-new summary-card">
                    <ul class="summary-list">
                        <li><span>Total Questions</span><span>${totalQuestions}</span></li>
                        <li><span>Correct Answers</span><span>${correctAnswers}</span></li>
                        <li><span>Incorrect Answers</span><span>${incorrectAnswers}</span></li>
                    </ul>
                </div>
                
                ${xpMessageHtml}

                <div class="quiz-result-card-new feedback-card">
                    <span class="feedback-text">${feedback.text}</span>
                    <span class="feedback-emoji">${feedback.emoji}</span>
                </div>
                
                <div class="card-buttons" style="margin-top:15px;">
                    <button class="btn btn-secondary" onclick="${backButtonAction}" style="flex:1;">Back to List</button>
                    <button class="btn btn-primary" id="view-quiz-ranks-btn" style="flex:1;">Your Rank</button>
                </div>
                `;
                
                AppController.navigateToPage('page-quiz-result');

                document.getElementById('view-quiz-ranks-btn').addEventListener('click', () => {
                    AppController.showQuizRanksPage(AppState.quiz.id, AppState.quiz.title);
                });

                const xpMessageEl = document.getElementById('xp-gain-message');
                if (xpMessageEl) {
                    setTimeout(() => {
                        xpMessageEl.style.opacity = '0';
                        xpMessageEl.style.maxHeight = '0';
                        xpMessageEl.style.margin = '0';
                        xpMessageEl.style.padding = '0';
                        xpMessageEl.style.border = '0';
                        setTimeout(() => { 
                            if (xpMessageEl) xpMessageEl.remove();
                        }, 500); 
                    }, 3000); 
                }
            },
            renderQuizRanksPage(quizId, quizTitle) {
                const container = document.getElementById('quiz-ranks-container');
                document.getElementById('quiz-ranks-title').textContent = `${quizTitle} Ranks`;
                container.innerHTML = `<div class="empty-state">Loading ranks...</div>`;

                // MODIFIED: Changed limitToLast(50) to limitToLast(10)
                db.ref(`quizResults/${quizId}`).orderByChild('score').limitToLast(10).once('value', snapshot => {
                    if (!snapshot.exists()) {
                        container.innerHTML = `<div class="empty-state">No one has taken this test yet. Be the first!</div>`;
                        return;
                    }

                    const results = AppController.firebaseObjectToArray(snapshot.val());
                    const sortedResults = results.sort((a, b) => b.score - a.score);
                    const currentUserId = AppState.session.currentUser.uid;
                    let currentUserRank = -1;
                    let currentUserData = null;
                    
                    // MODIFIED: Added .slice(0, 10) to ensure only top 10 are shown
                    const rankListHtml = sortedResults.slice(0, 10).map((result, index) => {
                        const rank = index + 1;
                        const isCurrentUser = result.userId === currentUserId;
                        if (isCurrentUser) {
                            currentUserRank = rank;
                            currentUserData = result;
                        }
                        let rankClass = `quiz-rank-list-item rank-${rank}`;
                        if(isCurrentUser) {
                            rankClass += ' current-user-rank';
                        }
                        return `
                        <div class="${rankClass}">
                            <div class="quiz-rank-number">${rank}</div>
                            <div class="quiz-rank-user-name">${result.userName}</div>
                            <div class="quiz-rank-score">${result.score}/${result.total}</div>
                        </div>
                        `;
                    }).join('');

                    let userRankHtml = '';
                    if (currentUserRank !== -1 && currentUserData) {
                        userRankHtml = `
                        <div class="your-rank-highlight">
                            <p>Your Rank</p>
                            <div class="rank-number">#${currentUserRank}</div>
                            <p>Score: ${currentUserData.score}/${currentUserData.total}</p>
                        </div>`;
                    } else {
                        userRankHtml = `<div class="empty-state" style="padding: 20px;">You are not in the Top 10. Keep trying!</div>`;
                    }
                    
                    container.innerHTML = userRankHtml + rankListHtml;
                });
            },
            getLevelBadgeDetails(level) { const colors = ['#e74c3c', '#3498db', '#2ecc71', '#9b59b6', '#f1c40f', '#1abc9c', '#e67e22', '#34495e', '#d35400', '#2980b9', '#27ae60', '#8e44ad', '#c0392b', '#16a085', '#f39c12', '#7f8c8d', '#000000', '#ff69b4', '#6a3805', '#4a148c']; const color = colors[level - 1] || colors[colors.length - 1]; return { color, icon: `${level}` }; },
            renderLevelCarousel(currentLevel = 1) {
                const track = document.getElementById('level-carousel-track'); const pillar = document.getElementById('current-level-pillar'); if (!track || !pillar) return;
                let trackHtml = '';
                for (let i = 1; i <= 20; i++) { const { color, icon } = this.getLevelBadgeDetails(i); trackHtml += `<div class="level-badge-item" data-level="${i}" style="background-color: ${color};">${icon}</div>`; }
                track.innerHTML = trackHtml;
                const currentBadgeDetails = this.getLevelBadgeDetails(currentLevel);
                pillar.innerHTML = `<div class="level-badge-item" style="background-color:${currentBadgeDetails.color}; --glow-color:${currentBadgeDetails.color};">${currentBadgeDetails.icon}</div><div class="current-level-pillar-text">Level ${currentLevel}</div>`;
                setTimeout(() => { const badgeWidth = 50; const gap = 25; const offset = (badgeWidth + gap) * (currentLevel - 1); track.style.transform = `translateX(-${offset}px)`; }, 100);
            },
            renderLeaderboardZones(rank) {
                const indicator = document.getElementById('user-rank-indicator'); if (!indicator) return;
                const rankBox = indicator.querySelector('.user-rank-box');
                if (!rank || rank > 30) { indicator.style.display = 'none'; return; }
                indicator.style.display = 'block'; rankBox.textContent = `Rank: ${rank}`;
                const positionPercent = ((30 - rank) / 29) * 100; indicator.style.left = `${positionPercent}%`;
            },
            renderLeaderboard(users) {
                const container = document.getElementById('leaderboard-container');
                if (!users || users.length === 0) {
                    container.innerHTML = `<div class="empty-state">Leaderboard is empty.</div>`;
                    this.renderLeaderboardZones(null);
                    return;
                }
                const currentUserId = AppState.session.currentUser?.uid;
                let currentUserRank = null;
                const leaderboardHtml = users.map((user, index) => {
                    const rank = index + 1;
                    let rankDisplay = rank;
                    if (rank === 1) rankDisplay = `<span class="rank-icon">🥇</span>`;
                    if (rank === 2) rankDisplay = `<span class="rank-icon">🥈</span>`;
                    if (rank === 3) rankDisplay = `<span class="rank-icon">🥉</span>`;
                    let zoneClass = '';
                    if (rank <= 14) { zoneClass = 'promotion-zone'; }
                    else if (rank <= 26) { zoneClass = 'safety-zone'; }
                    else { zoneClass = 'demotion-zone'; }
                    const isCurrentUser = user.id === currentUserId;
                    if (isCurrentUser) { currentUserRank = rank; }
                    const name = user.name || 'Anonymous';
                    const xp = user.xp || 0;
                    return `<div class="leaderboard-item ${zoneClass} rank-${rank} ${isCurrentUser ? 'current-user' : ''}"><div class="rank">${rankDisplay}</div><div class="leaderboard-user-name">${name} ${isCurrentUser ? '(You)' : ''}</div><div class="leaderboard-xp">${xp} <span class="xp-label">XP</span></div></div>`;
                }).join('');
                container.innerHTML = `<div class="leaderboard-list">${leaderboardHtml}</div>`;
                this.renderLeaderboardZones(currentUserRank);
            },
            renderFilterBar(type) {
                const container = document.getElementById(`${type}-filter-container`);
                if (!container) return;
                const currentFilter = AppState.ui.filters[type] || 'all';
                const classOptions = ['6', '7', '8', '9', '10', '11', '12']
                    .map(c => `<option value="${c}" ${currentFilter == c ? 'selected' : ''}>Class ${c}</option>`)
                    .join('');

                container.innerHTML = `
                    <button class="filter-bar-btn ${currentFilter === 'all' ? 'active' : ''}" data-class="all">All</button>
                    <select class="filter-bar-select">
                        <option value="all" ${currentFilter === 'all' ? 'selected' : ''}>All Classes</option>
                        ${classOptions}
                    </select>
                `;
            },
            renderPaymentPage(course, orderId) {
                const container = document.getElementById('payment-gateway-content');
                const paymentDetails = AppState.data.settings.paymentDetails;

                if (!paymentDetails || !paymentDetails.qrCodeUrl || !paymentDetails.upiId) {
                    container.innerHTML = `<div class="empty-state">Payment details are not configured by the admin. Please try again later or contact support.</div>`;
                    return;
                }
                
                const contentHtml = `
                <div class="payment-wrapper">
                    <div class="payment-card">
                        <h3>Pay for: ${course.title}</h3>
                        <p>Total Amount to Pay: <strong>₹${course.price}</strong></p>
                    </div>

                    <div class="payment-card">
                        <p><strong>Step 1:</strong> Copy your unique Order ID.</p>
                        <div class="order-id-box">
                            <p>Your Unique Order ID</p>
                            <div class="the-id" id="order-id-text">${orderId}</div>
                            <button class="btn copy-btn" id="copy-order-id-btn">Copy ID</button>
                        </div>
                    </div>
                     
                    <div class="payment-card">
                        <p><strong>Step 2:</strong> Scan the QR code with any UPI app to pay.</p>
                         <div class="important-instruction">
                            <strong>IMPORTANT:</strong> Payment करते समय UPI app के "Add a Note" या "Message" section में अपनी Order ID (<strong>${orderId}</strong>) ज़रूर डालें।
                        </div>
                        <div class="qr-code-container">
                            <img src="${paymentDetails.qrCodeUrl}" alt="UPI QR Code">
                            <p class="upi-id-text">or pay to: ${paymentDetails.upiId}</p>
                        </div>
                    </div>

                    <div class="payment-card">
                        <h3>Step 3: Payment के बाद UTR नंबर डालें</h3>
                        <div class="utr-info-card">
                            <h4>UTR नंबर क्या है और कहाँ मिलेगा?</h4>
                            <p>जब आप UPI से पेमेंट करते हैं, तो आपका बैंक उस पेमेंट को एक **12-अंकों का यूनिक नंबर** देता है। इसे ही UTR (Unique Transaction Reference) नंबर कहते हैं।</p>
                            <p>पेमेंट करने के बाद, अपने UPI ऐप (PhonePe, Google Pay, etc.) की **Transaction History** में जाकर उस पेमेंट की Details देखें। वहाँ आपको **UTR / Transaction ID / UPI Reference No.** लिखा हुआ मिलेगा।</p>
                            <p><strong>उदाहरण:</strong> 529812345678</p>
                        </div>
                         <form id="utr-submit-form" data-course-id="${course.id}" data-order-id="${orderId}" data-course-title="${course.title}" data-course-price="${course.price}" style="margin-top:20px;">
                            <div class="form-group">
                                <label>Enter 12-Digit UTR Number Here</label>
                                <input type="tel" id="utr-input" required minlength="12" maxlength="12" pattern="[0-9]{12}" inputmode="numeric" placeholder="12 अंकों का नंबर डालें">
                            </div>
                            <button type="submit" class="btn btn-primary" style="width:100%;">Submit & Confirm Payment</button>
                        </form>
                    </div>
                </div>`;
                container.innerHTML = contentHtml;
            }
        };

        const AppController = {
            init() {
                this.checkOnlineStatus();

                const splash = document.getElementById('splash-screen');
                const authContainer = document.getElementById('auth-container'); 
                const mainAppContainer = document.getElementById('main-app-container');

                auth.onAuthStateChanged(user => {
                    const wasLoggedIn = !!AppState.session.currentUser;
                    AppState.session.currentUser = user;
                    
                    const showApp = () => {
                        splash.style.opacity = '0';
                        setTimeout(() => splash.style.display = 'none', 500);
                        if (user) {
                           mainAppContainer.style.display = 'block';
                           authContainer.style.display = 'none';
                        } else {
                           mainAppContainer.style.display = 'none';
                           authContainer.style.display = 'flex';
                        }
                    };

                    if (user) {
                        db.ref('users/' + user.uid).on('value', s => { 
                            const oldUserData = AppState.session.userData;
                            const newUserData = s.val();
                            AppState.session.userData = newUserData;

                            if (!oldUserData) { 
                                this.refreshUI(); 
                                if (!wasLoggedIn) {
                                    const lastPageId = sessionStorage.getItem('lastActivePageId') || 'page-home';
                                    if(lastPageId) sessionStorage.removeItem('lastActivePageId');
                                    this.navigateToPage(lastPageId, false);
                                }
                            } else {
                                this.handleUserDataUpdate(oldUserData, newUserData);
                            }
                            
                            showApp();
                        });
                    } else { 
                        AppState.session.userData = null;
                        AppState.session.currentUser = null;
                        this.navigateToPage('page-auth-login'); 
                        showApp();
                    }
                });
                this.loadInitialData(); this.bindEvents();
            },

            handleUserDataUpdate(oldData, newData) {
                AppState.session.userData = newData;
                
                UI.updateMenuHeader();
                UI.updateNotificationIcon();
                this.renderHeaderXP(); // Update XP display

                const oldTheme = oldData?.settings?.darkMode;
                const newTheme = newData?.settings?.darkMode;
                if (oldTheme !== newTheme) {
                    document.documentElement.dataset.theme = newTheme ? 'dark' : 'light';
                }
                
                const activePage = document.querySelector('.page.active');
                if (activePage) {
                    const pageId = activePage.id;
                    if (['page-home', 'page-my-courses', 'page-profile', 'page-leaderboard', 'page-study'].includes(pageId)) {
                        this.loadPageContent(pageId);
                    }
                }
            },

            checkOnlineStatus() {
                if (!navigator.onLine) {
                   // You can optionally show a small toast/banner here if needed
                }
            },
            loadInitialData() {
                db.ref('courses').on('value', s => { AppState.data.courses = this.firebaseObjectToArray(s.val()); this.refreshUI(); });
                db.ref('settings').on('value', s => {
                    AppState.data.settings = s.val() || {};
                    UI.applySettings();
                });
                db.ref('mcq_sets').on('value', s => { AppState.data.mcqs = this.firebaseObjectToArray(s.val()); });
                db.ref('tests').on('value', s => { AppState.data.tests = this.firebaseObjectToArray(s.val()); });
                db.ref('pdfs').on('value', s => { AppState.data.pdfs = this.firebaseObjectToArray(s.val()); });
                db.ref('users').orderByChild('xp').limitToLast(30).on('value', snapshot => {
                    const users = this.firebaseObjectToArray(snapshot.val());
                    AppState.data.leaderboard = users.sort((a, b) => (b.xp || 0) - (a.xp || 0));
                    if (document.querySelector('#page-leaderboard.active')) {
                        this.loadPageContent('page-leaderboard');
                    }
                });
                db.ref('schedules').on('value', s => { 
                    AppState.data.schedules = s.val() || {}; 
                    if (document.getElementById('page-study').classList.contains('active')) {
                        this.renderStudyPageContent(AppState.ui.selectedStudyBatchId);
                    }
                });
            },
            refreshUI() {
                if (AppState.session.currentUser && AppState.session.userData) {
                    UI.updateHeader();
                    UI.updateMenuHeader();
                    UI.applySettings();
                    UI.updateNotificationIcon();
                    this.renderHeaderXP();
                    const activePage = document.querySelector('#main-app-container .page.active');
                    if(activePage) this.loadPageContent(activePage.id);
                } else {
                    UI.applySettings();
                }
            },
            bindEvents() {
                window.addEventListener('online', this.checkOnlineStatus);
                window.addEventListener('offline', this.checkOnlineStatus);

                window.addEventListener('pagehide', () => {
                    const activePage = document.querySelector('.page.active');
                    if (activePage && !activePage.id.startsWith('page-auth')) {
                        sessionStorage.setItem('lastActivePageId', activePage.id);
                    }
                });

                document.getElementById('top-search-bar').addEventListener('click', () => {
                    this.navigateToPage('page-search');
                });
                document.getElementById('study-btn').addEventListener('click', () => this.navigateToPage('page-study'));
                 document.getElementById('header-xp-display').addEventListener('click', () => this.navigateToPage('page-leaderboard'));
                
                document.body.addEventListener('submit', (e) => {
                    e.preventDefault(); 
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    if (e.target.id === 'login-form') { 
                        this.login(document.getElementById('login-email').value, document.getElementById('login-password').value, submitBtn); 
                    } 
                    else if (e.target.id === 'signup-form') { 
                        const username = document.getElementById('signup-username').value;
                        const userClass = document.getElementById('signup-class').value;
                        const email = document.getElementById('signup-email').value;
                        const mobile = document.getElementById('signup-mobile').value;
                        const password = document.getElementById('signup-password').value;
                        const confirmPassword = document.getElementById('signup-confirm-password').value;
                        this.signup(username, userClass, email, mobile, password, confirmPassword, submitBtn); 
                    } 
                    else if (e.target.id === 'reset-password-form') { 
                        this.handlePasswordReset(document.getElementById('reset-email').value, submitBtn); 
                    }
                    else if (e.target.id === 'utr-submit-form') { this.handleUtrSubmit(e.target); }
                    else if (e.target.id === 'user-chat-form') { this.handleUserSendMessage(e); }
                    else if (e.target.id === 'live-chat-form') { this.handleLiveChatMessageSend(e); }
                });

                document.getElementById('header-auth-section').addEventListener('click', e => { if (e.target.closest('#menu-btn')) this.toggleMenu(true); });
                document.getElementById('notification-btn').addEventListener('click', () => {
                    const uid = AppState.session.currentUser.uid;
                    db.ref(`users/${uid}/notificationsLastChecked`).set(firebase.database.ServerValue.TIMESTAMP);
                    if (AppState.session.userData) AppState.session.userData.notificationsLastChecked = Date.now();
                    UI.updateNotificationIcon(); 
                    this.navigateToPage('page-notifications');
                });
                document.getElementById('menu-overlay').addEventListener('click', () => this.toggleMenu(false));
                document.getElementById('view-profile-btn').addEventListener('click', () => { this.navigateToPage('page-profile'); this.toggleMenu(false); });
                document.getElementById('logout-btn').addEventListener('click', () => { this.handleLogout(); });
                document.getElementById('menu-nav-links').addEventListener('click', e => {
                    const link = e.target.closest('.menu-nav-item');
                    if (link) {
                        e.preventDefault();
                        if (link.id === 'share-app-btn') {
                            const shareData = {
                                title: 'ASAG – Apna Study Apna Group',
                                text: '🎓 ASAG – Apna Study Apna Group: Smart Study, Easy Success!',
                                url: 'https://www.appcreator24.com/app3803365-q7jx9n'
                            };
                            if (navigator.share && navigator.canShare(shareData)) {
                                navigator.share(shareData).catch(err => console.error("Share failed:", err));
                            } else {
                                // Fallback for browsers that don't support share
                                navigator.clipboard.writeText(shareData.text + " " + shareData.url)
                                    .then(() => alert("App link copied to clipboard!"))
                                    .catch(() => alert("Could not share or copy the link."));
                            }
                        } else {
                            this.navigateToPage(link.dataset.page);
                        }
                        this.toggleMenu(false);
                    }
                });
                
                document.querySelector('.bottom-nav').addEventListener('click', e => { const n = e.target.closest('.nav-item'); if (n) { e.preventDefault(); this.navigateToPage(n.dataset.page); } });
                document.getElementById('search-input').addEventListener('input', e => this.handleSearch(e.target.value));
                document.getElementById('course-contents-back-btn').addEventListener('click', () => this.navigateBack());
                document.getElementById('chapters-back-btn').addEventListener('click', () => this.navigateBack());
                document.getElementById('lectures-back-btn').addEventListener('click', () => this.navigateBack());
                document.getElementById('buy-now-back-btn').addEventListener('click', () => this.navigateBack());
                document.getElementById('payment-gateway-back-btn').addEventListener('click', () => this.navigateBack());
                document.getElementById('see-more-batches-btn').addEventListener('click', (e) => { e.preventDefault(); this.navigateToPage('page-all-other-batches'); });
                document.getElementById('pdf-viewer-back-btn').addEventListener('click', () => this.navigateBack());
                document.getElementById('quiz-result-back-btn').addEventListener('click', () => {
                     if (AppState.quiz.source === 'course') {
                        this.navigateBack();
                    } else {
                        this.navigateToPage(`page-${AppState.quiz.type}`);
                    }
                });
                
                document.body.addEventListener('click', e => {
                    const downloadBtn = e.target.closest('.download-btn');
                    if (downloadBtn) {
                        // Let the default browser download behavior happen
                        // No e.preventDefault()
                        this.handleDirectDownload(downloadBtn);
                        // The 'a' tag will handle the download itself.
                    }

                    // --- The rest of the click events ---
                    const contentArea = e.target.closest('.detail-content, #page-about-us');
                    if (e.target.tagName === 'IMG' && contentArea && !e.target.closest('.course-thumbnail')) {
                        e.preventDefault();
                        this.showImageViewer(e.target.src);
                        return;
                    }

                    if (!e.target.closest('#pdf-options-btn')) {
                        const pdfDropdown = document.getElementById('pdf-dropdown-menu');
                        if(pdfDropdown) pdfDropdown.classList.remove('visible');
                    }
                    
                    const paymentPage = e.target.closest('#page-payment-gateway');
                    if (paymentPage) {
                        if (e.target.id === 'copy-order-id-btn') {
                            const orderIdText = document.getElementById('order-id-text').textContent;
                            navigator.clipboard.writeText(orderIdText).then(() => {
                                e.target.textContent = 'Copied!';
                                setTimeout(() => { e.target.textContent = 'Copy ID'; }, 2000);
                            });
                        }
                        return; 
                    }
                    
                    const pdfViewerBtn = e.target.closest('.pdf-viewer-btn');
                    if(pdfViewerBtn) { e.preventDefault(); const url = pdfViewerBtn.dataset.url; const title = pdfViewerBtn.dataset.title; this.showPdfViewer(url, title); return; }
                    const watchBtn = e.target.closest('.video-watch-btn');
                    if (watchBtn) { const itemData = JSON.parse(watchBtn.closest('.content-card-wrapper').dataset.item); this.showVideoPlayerPage(itemData); return; }
                    
                    const startCourseTestBtn = e.target.closest('.start-course-test-btn');
                    if (startCourseTestBtn) {
                        const itemWrapper = startCourseTestBtn.closest('.content-card-wrapper');
                        const itemData = JSON.parse(itemWrapper.dataset.item);
                        this.startQuiz('test', itemWrapper.dataset.id, 'course', itemData.questions, itemData.title);
                        return;
                    }

                    const courseCard = e.target.closest('.course-card');
                    const courseId = courseCard?.dataset.id || e.target.dataset.id;
                    if (e.target.classList.contains('enroll-btn')) { e.preventDefault(); this.enroll(courseId); }
                    else if (e.target.classList.contains('buy-now-btn')) { e.preventDefault(); this.showBuyNowPage(courseId); }
                    else if (e.target.classList.contains('explore-btn')) { e.preventDefault(); const course = AppState.data.courses.find(c => c.id === courseId); if (course) UI.showDetailPage(course); }
                    else if (e.target.classList.contains('lets-study-btn')) { e.preventDefault(); this.showCourseContentsPage(courseId); }
                    else if (e.target.classList.contains('proceed-btn')) { e.preventDefault(); this.buy(courseId); }
                    
                    const clickableArea = e.target.closest('.course-card-clickable-area');
                    if (clickableArea) { e.preventDefault(); const id = clickableArea.closest('.course-card')?.dataset.id; if (id) { const c = AppState.data.courses.find(c => c.id === id); if (c) UI.showDetailPage(c); } }
                    
                    const nonCarouselBanner = e.target.closest('#top-banner-wrapper a, #mid-page-banner-container a');
                    if (nonCarouselBanner && nonCarouselBanner.dataset.courseId) {
                        e.preventDefault();
                        const course = AppState.data.courses.find(c => c.id === nonCarouselBanner.dataset.courseId);
                        if (course) UI.showDetailPage(course);
                    }

                    const quickLink = e.target.closest('.quick-link-item');
                     if (quickLink) { e.preventDefault(); this.navigateToPage(quickLink.dataset.page); }
                    const subjectItem = e.target.closest('.subject-accordion-item'); if(subjectItem) { const { courseId, subjectId, subjectTitle } = subjectItem.dataset; this.showChaptersPage(courseId, subjectId, subjectTitle); }
                    const chapterItem = e.target.closest('.chapter-card'); if(chapterItem) { const { courseId, subjectId, chapterId, chapterTitle } = chapterItem.dataset; this.showLecturesPage(courseId, subjectId, chapterId, chapterTitle); }
                    if (e.target.classList.contains('password-toggle')) { const input = e.target.previousElementSibling; input.type = input.type === 'password' ? 'text' : 'password'; e.target.textContent = input.type === 'password' ? '👁️' : '🙈'; }
                    
                    const learningShortcut = e.target.closest('.learning-shortcut-btn');
                    if (learningShortcut) {
                         e.preventDefault();
                         const page = learningShortcut.dataset.page;
                         if(page === 'page-dashboard') {
                            this.navigateToPage('page-dashboard', true, { batchId: AppState.ui.selectedStudyBatchId });
                         } else {
                            this.navigateToPage(page);
                         }
                    }
                    
                    const quizPageActive = AppState.quiz.type && !document.getElementById('page-quiz-result').classList.contains('active') && !document.getElementById('page-quiz-ranks').classList.contains('active');
                    if (quizPageActive) {
                        const t = e.target; 
                        const qIndex = AppState.quiz.currentIndex; 
                        const q = AppState.quiz.questions[qIndex]; 
                        if (!q) return; 
                        if (t.classList.contains('quiz-option') && !AppState.quiz.isSubmitted[qIndex]) { AppState.quiz.userAnswers[qIndex] = t.dataset.option; UI.renderQuiz(); } 
                        if (t.id === 'quiz-submit-btn') this.submitQuizAnswer(); 
                        if (t.id === 'quiz-next-btn') this.navigateQuiz(1); 
                        if (t.id === 'quiz-prev-btn') this.navigateQuiz(-1); 
                        if (t.id === 'quiz-finish-btn') UI.renderQuizResult();
                    }
                });
                
                document.getElementById('detail-back-btn').addEventListener('click', UI.hideDetailPage);
                document.querySelector('.auth-nav').addEventListener('click', e => { const btn = e.target.closest('.auth-nav-btn'); if (btn) { this.navigateToPage(btn.dataset.page, false); } });
                document.getElementById('video-player-back-btn').addEventListener('click', () => {
                    const video = document.getElementById('video-player-element');
                    video.pause();
                    const iframeContainer = document.getElementById('iframe-player-container');
                    iframeContainer.innerHTML = '';
                    if (document.fullscreenElement) document.exitFullscreen();
                    this.navigateBack();
                });
                document.getElementById('video-input-form').addEventListener('submit', this.handleVideoInputSubmit);
                document.getElementById('video-comments-btn').addEventListener('click', () => this.setVideoPlayerMode('comments'));
                document.getElementById('video-ask-question-btn').addEventListener('click', () => this.setVideoPlayerMode('questions'));
                
                const filterTypes = ['mcq', 'pdf', 'test'];
                filterTypes.forEach(type => {
                    const container = document.getElementById(`${type}-filter-container`);
                    if (container) {
                        container.addEventListener('click', (e) => {
                            if (e.target.classList.contains('filter-bar-btn')) { this.updateFilter(type, 'all'); }
                        });
                        container.addEventListener('change', (e) => {
                            if (e.target.classList.contains('filter-bar-select')) { this.updateFilter(type, e.target.value); }
                        });
                    }
                });
                
                // --- NEW: Listeners for Image Viewer Modal ---
                document.getElementById('image-viewer-close').addEventListener('click', this.hideImageViewer);
                document.getElementById('image-viewer-img').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    e.target.classList.toggle('zoomed');
                });
                document.getElementById('image-viewer-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'image-viewer-modal') {
                        this.hideImageViewer();
                    }
                });
            },
            toggleMenu: (show) => {
                document.body.classList.toggle('menu-open', show);
                document.body.style.overflow = show ? 'hidden' : '';
            },
            startMainCarousel(count) {
                if (count <= 1) {
                    document.getElementById('carousel-dots').style.display = 'none';
                    return;
                }
                
                const container = document.getElementById('hero-carousel-container');
                const track = document.getElementById('carousel-track');
                const slides = track.querySelectorAll('.carousel-slide');
                const dots = document.querySelectorAll('#carousel-dots .dot');
                let isDragging = false, startPos = 0, currentTranslate = 0, prevTranslate = 0, animationID;
                AppState.ui.mainCarousel.slide = 0;
                AppState.ui.mainCarousel.wasDragged = false;

                const setPositionByIndex = () => {
                    if(!container) return;
                    currentTranslate = AppState.ui.mainCarousel.slide * -container.offsetWidth;
                    prevTranslate = currentTranslate;
                    track.style.transform = `translateX(${currentTranslate}px)`;
                }

                const updateUI = () => {
                    track.style.transform = `translateX(${currentTranslate}px)`;
                    dots.forEach(dot => dot.classList.remove('active'));
                    if(dots[AppState.ui.mainCarousel.slide]) {
                        dots[AppState.ui.mainCarousel.slide].classList.add('active');
                    }
                    
                    slides.forEach((slide, index) => {
                        const video = slide.querySelector('video');
                        if (video) {
                            if (index === AppState.ui.mainCarousel.slide) {
                                video.play().catch(()=>{});
                            } else {
                                video.pause();
                                video.currentTime = 0;
                            }
                        }
                    });
                }
                
                const scheduleNext = () => {
                    if (AppState.ui.mainCarousel.timer) clearTimeout(AppState.ui.mainCarousel.timer);
                    const currentSlide = slides[AppState.ui.mainCarousel.slide];
                    const video = currentSlide ? currentSlide.querySelector('video') : null;
                    
                    const advance = () => {
                         if (isDragging) return;
                         AppState.ui.mainCarousel.slide = (AppState.ui.mainCarousel.slide + 1) % count;
                         track.style.transition = 'transform 0.5s ease-in-out';
                         setPositionByIndex();
                         updateUI();
                         scheduleNext();
                    };

                    if (video) {
                        video.onended = advance;
                    } else {
                       AppState.ui.mainCarousel.timer = setTimeout(advance, 3500);
                    }
                }
                
                const dragStart = (e) => {
                    e.preventDefault();
                    isDragging = true;
                    AppState.ui.mainCarousel.wasDragged = false;
                    startPos = e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
                    track.style.transition = 'none';
                    if (AppState.ui.mainCarousel.timer) clearTimeout(AppState.ui.mainCarousel.timer);
                    animationID = requestAnimationFrame(animation);
                };
                
                const dragMove = (e) => {
                    if(isDragging) {
                       const currentPosition = e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
                       if (Math.abs(currentPosition - startPos) > 10) {
                           AppState.ui.mainCarousel.wasDragged = true;
                       }
                       currentTranslate = prevTranslate + currentPosition - startPos;
                    }
                };
                
                const dragEnd = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    cancelAnimationFrame(animationID);
                    
                    const movedBy = currentTranslate - prevTranslate;
                    if (movedBy < -100 && AppState.ui.mainCarousel.slide < count - 1) AppState.ui.mainCarousel.slide += 1;
                    if (movedBy > 100 && AppState.ui.mainCarousel.slide > 0) AppState.ui.mainCarousel.slide -= 1;
                    
                    track.style.transition = 'transform 0.5s ease-in-out';
                    setPositionByIndex();
                    updateUI();
                    scheduleNext();
                };
                
                const animation = () => {
                    track.style.transform = `translateX(${currentTranslate}px)`;
                    if(isDragging) requestAnimationFrame(animation);
                }

                slides.forEach((slide) => {
                    slide.addEventListener('dragstart', (e) => e.preventDefault());
                    slide.addEventListener('mousedown', dragStart);
                    slide.addEventListener('touchstart', dragStart, { passive: true });
                    slide.addEventListener('click', (e) => {
                        if (AppState.ui.mainCarousel.wasDragged) {
                            e.preventDefault();
                            e.stopPropagation();
                            return;
                        }
                        const courseId = slide.dataset.courseId;
                        if (courseId && courseId !== "null" && courseId !== "" && AppState.data.courses) {
                            const course = AppState.data.courses.find(c => c.id === courseId);
                            if (course) UI.showDetailPage(course);
                        }
                    });
                });
                container.addEventListener('mouseup', dragEnd);
                container.addEventListener('mouseleave', dragEnd);
                container.addEventListener('touchend', dragEnd);
                container.addEventListener('mousemove', dragMove);
                container.addEventListener('touchmove', dragMove, { passive: true });
                window.addEventListener('resize', setPositionByIndex);

                setPositionByIndex();
                updateUI();
                scheduleNext();
            },
            renderProfilePage() {
                const container = document.getElementById('profile-content');
                const user = AppState.session.userData || {};
                const name = user.name || 'Anonymous';
                const initial = (name ? name.charAt(0) : '?').toUpperCase();
                const profilePic = user.profileImageUrl ? `<img src="${user.profileImageUrl}" alt="Profile" class="profile-page-avatar">` : `<div class="profile-page-avatar profile-page-avatar-initial">${initial}</div>`;

                const content = `
                    <div class="profile-header-card">
                        <div class="profile-picture-section">
                            ${profilePic}
                            <div class="profile-user-details">
                                <span class="username">${name}</span>
                                <button class="change-picture-btn" onclick="AppController.showEditModal('picture')">Change Picture</button>
                            </div>
                        </div>
                        <div class="level-overview-section">
                            <div><h4>${user.xp || 0}</h4><p>Total XP</p></div>
                            <div><h4>${user.level || 1}</h4><p>Current Level</p></div>
                        </div>
                    </div>

                    <div class="profile-details-card">
                        <div class="section-header"><h3>Your Details</h3><button class="edit-btn" onclick="AppController.showEditModal('personal')">Edit</button></div>
                        <div class="details-list">
                            <div class="detail-item"><span>Username</span> <span>${user.name || 'Not Set'}</span></div>
                            <div class="detail-item"><span>Email</span> <span>${user.email || 'Not Set'}</span></div>
                            <div class="detail-item"><span>Mobile</span> <span>${user.mobile || 'Not Set'}</span></div>
                        </div>
                    </div>

                    <div class="profile-details-card">
                        <div class="section-header"><h3>Other Details</h3><button class="edit-btn" onclick="AppController.showEditModal('other')">Edit</button></div>
                        <div class="details-list">
                             <div class="detail-item"><span>Exam</span> <span>${user.exam || 'Not Set'}</span></div>
                            <div class="detail-item"><span>Class</span> <span>${user.class ? 'Class ' + user.class : 'Not Set'}</span></div>
                            <div class="detail-item"><span>City</span> <span>${user.city || 'Not Set'}</span></div>
                            <div class="detail-item"><span>State</span> <span>${user.state || 'Not Set'}</span></div>
                        </div>
                    </div>

                    <div class="profile-details-card">
                         <div class="section-header"><h3>Privacy & Security</h3></div>
                         <div class="details-list">
                            <div class="detail-item clickable" onclick="AppController.showPasswordChangeModal()">
                                <span>Change Password</span> <span class="arrow">></span>
                            </div>
                        </div>
                    </div>

                    <div class="profile-details-card">
                        <div class="dark-mode-row">
                            <span class="dark-mode-label">Dark Mode</span>
                            <label class="dark-mode-switch">
                                <input type="checkbox" id="dark-mode-toggle">
                                <span class="dark-mode-slider"></span>
                            </label>
                        </div>
                    </div>

                    <button id="profile-logout-btn" class="btn">Logout</button>
                `;
                container.innerHTML = content;
                document.getElementById('profile-logout-btn').addEventListener('click', () => { this.handleLogout(); });
                
                const darkModeToggle = document.getElementById('dark-mode-toggle');
                if(darkModeToggle){
                    darkModeToggle.checked = AppState.session.userData?.settings?.darkMode || AppState.data.settings?.darkMode || false;
                    darkModeToggle.addEventListener('change', e => {
                        const isChecked = e.target.checked;
                        const uid = AppState.session.currentUser.uid;
                        
                        document.documentElement.dataset.theme = isChecked ? 'dark' : 'light';
                        if (AppState.session.userData.settings) {
                           AppState.session.userData.settings.darkMode = isChecked;
                        } else {
                           AppState.session.userData.settings = { darkMode: isChecked };
                        }
                        if(uid) db.ref(`users/${uid}/settings/darkMode`).set(isChecked);
                    });
                }
            },
            renderAboutUsPage() {
                const container = document.getElementById('page-about-us');
                const aboutUsContent = AppState.data.settings.aboutUs || '<div class="empty-state">About Us content is not available yet.</div>';
                container.innerHTML = `
                    <header class="detail-header">
                        <button class="back-btn" onclick="AppController.navigateBack()">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                        </button>
                        <h2 class="detail-title">About Us</h2>
                    </header>
                    <div style="padding: 20px; white-space: pre-wrap; line-height: 1.8;">${aboutUsContent}</div>
                `;
            },
            renderUserChatInterface() {
                const container = document.getElementById('page-contact-us');
                const logoUrl = AppState.data.settings.logoUrl;

                container.innerHTML = `
                    <header class="detail-header">
                        <button class="back-btn" onclick="AppController.navigateBack()">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                        </button>
                        ${logoUrl ? `<img src="${logoUrl}" class="chat-header-logo">` : ''}
                        <h2 class="detail-title">ASAG Support</h2>
                    </header>
                    <div class="chat-area" id="user-chat-area"></div>
                    <div class="chat-form-container">
                        <form class="chat-form" id="user-chat-form">
                            <div class="chat-input-wrapper">
                                <textarea id="user-chat-input" placeholder="Message..." rows="1"></textarea>
                            </div>
                            <button type="submit" class="icon-btn" id="user-chat-send-btn">
                                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                            </button>
                        </form>
                        <p class="chat-subtext"
                    </div>`;

                this.loadUserChatMessages();
                this.bindChatEvents();
            },
            bindChatEvents() {
                const textarea = document.getElementById('user-chat-input');
                if (!textarea) return;
                textarea.addEventListener('input', () => {
                    textarea.style.height = 'auto';
                    textarea.style.height = (textarea.scrollHeight) + 'px';
                });
                textarea.addEventListener('focus', () => {
                    setTimeout(() => {
                        const formContainer = document.querySelector('#page-contact-us .chat-form-container');
                        if (formContainer) formContainer.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }, 300);
                });
            },
            formatDateSeparator(timestamp) {
                const messageDate = new Date(timestamp);
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                messageDate.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);
                yesterday.setHours(0, 0, 0, 0);

                if (messageDate.getTime() === today.getTime()) return 'Today';
                if (messageDate.getTime() === yesterday.getTime()) return 'Yesterday';
                
                const oneWeekAgo = new Date(today);
                oneWeekAgo.setDate(today.getDate() - 7);
                if (messageDate > oneWeekAgo) {
                    return messageDate.toLocaleString(undefined, { weekday: 'long' });
                }
                
                return messageDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            },
            loadUserChatMessages() {
                const chatArea = document.getElementById('user-chat-area');
                if (!AppState.session.currentUser || !chatArea) return;
                const userId = AppState.session.currentUser.uid;

                db.ref('contactMessages').orderByChild('userId').equalTo(userId).on('value', snapshot => {
                    if (!chatArea) return; 
                    if (!snapshot.exists()) {
                        chatArea.innerHTML = '<div class="empty-state" style="margin:auto; color: #aab2b8;">Send a message to start the conversation.</div>';
                        return;
                    }
                    const messages = this.firebaseObjectToArray(snapshot.val()).sort((a,b) => a.timestamp - b.timestamp);
                    let lastDateString = null;
                    
                    chatArea.innerHTML = messages.map(msg => {
                        let dateSeparatorHtml = '';
                        const messageDate = new Date(msg.timestamp);
                        const currentDateString = messageDate.toDateString();

                        if (currentDateString !== lastDateString) {
                            dateSeparatorHtml = `<div class="date-separator">${this.formatDateSeparator(msg.timestamp)}</div>`;
                            lastDateString = currentDateString;
                        }

                        const wrapperClass = msg.sender === 'admin' ? 'received' : 'sent';
                        const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }).toLowerCase();

                        const messageBubbleHtml = `
                        <div class="message-bubble-wrapper ${wrapperClass}" data-id="${msg.id}" data-sender="${msg.sender}">
                            <div class="message-bubble-content">
                                <div class="message-text">${msg.text || msg.message || ''}</div>
                                <div class="message-time">${time}</div>
                            </div>
                        </div>`;
                        
                        return dateSeparatorHtml + messageBubbleHtml;
                    }).join('');

                    chatArea.scrollTop = chatArea.scrollHeight;
                });
            },
            async handleUserSendMessage(e) {
                e.preventDefault();
                const input = document.getElementById('user-chat-input');
                const text = input.value.trim();

                if (!text) return;

                const sendBtn = document.getElementById('user-chat-send-btn');
                sendBtn.disabled = true;

                const messageData = {
                    text: text,
                    attachmentUrl: null,
                    sender: 'user',
                    userId: AppState.session.currentUser.uid,
                    name: AppState.session.userData.name,
                    email: AppState.session.currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    isReadByAdmin: false
                };
                
                db.ref('contactMessages').push(messageData).then(() => {
                    input.value = '';
                    input.style.height = 'auto';
                    sendBtn.disabled = false;
                }).catch(err => {
                    alert('Failed to send message.');
                    sendBtn.disabled = false;
                });
            },
            showEditModal(type) {
                const user = AppState.session.userData || {};
                let title = '';
                let formContent = '';
                let formId = '';

                if (type === 'picture') {
                    title = "Change Profile Picture";
                    formId = "picture-edit-form";
                    formContent = `
                        <div class="form-group">
                            <label>Picture Source</label>
                            <select id="edit-picture-source">
                                <option value="file">Upload from Device</option>
                                <option value="url">Enter Image URL</option>
                            </select>
                        </div>
                        <div class="form-group" id="file-upload-group">
                            <label>Upload Picture</label>
                            <input type="file" id="edit-picture" accept="image/*" style="padding: 8px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div class="form-group hidden" id="url-upload-group">
                            <label>Image URL</label>
                            <input type="url" id="edit-picture-url" placeholder="https://example.com/image.png">
                        </div>
                        <button type="button" id="remove-picture-btn" class="btn" style="width:100%; margin-top: 10px; background-color: var(--error-color); color: white; ${user.profileImageUrl ? '' : 'display:none;'}">Remove Picture</button>
                    `;
                } else if (type === 'personal') {
                    title = "Edit Your Details";
                    formId = "personal-edit-form";
                    formContent = `
                        <div class="form-group"><label>Username</label><input type="text" id="edit-name" value="${user.name || ''}" required></div>
                        <div class="form-group"><label>Mobile Number</label><input type="tel" id="edit-mobile" value="${user.mobile || ''}"></div>
                    `;
                } else if (type === 'other') {
                    title = "Edit Other Details";
                    formId = "other-edit-form";
                    let classOptions = ['6', '7', '8', '9', '10', '11', '12'].map(c => `<option value="${c}" ${user.class == c ? 'selected' : ''}>Class ${c}</option>`).join('');
                    formContent = `
                        <div class="form-group"><label>Exam</label><input type="text" id="edit-exam" value="${user.exam || ''}"></div>
                        <div class="form-group"><label>Class</label><select id="edit-class"><option value="">-- Select Class --</option>${classOptions}</select></div>
                        <div class="form-group"><label>City</label><input type="text" id="edit-city" value="${user.city || ''}"></div>
                        <div class="form-group"><label>State</label><input type="text" id="edit-state" value="${user.state || ''}"></div>
                    `;
                }
                
                const modalContent = `<form id="${formId}">${formContent}<button type="submit" class="btn btn-primary" style="width:100%; margin-top: 15px;">Save Changes</button></</form>`;
                UI.showModal(title, modalContent);

                if (type === 'picture') {
                    const sourceSelect = document.getElementById('edit-picture-source');
                    sourceSelect.addEventListener('change', (e) => {
                        document.getElementById('file-upload-group').classList.toggle('hidden', e.target.value === 'url');
                        document.getElementById('url-upload-group').classList.toggle('hidden', e.target.value === 'file');
                    });
                     if (user.profileImageUrl) {
                        document.getElementById('remove-picture-btn').addEventListener('click', async () => {
                             if (!confirm("Are you sure?")) return;
                             await db.ref(`users/${AppState.session.currentUser.uid}/profileImageUrl`).remove();
                             document.getElementById('modal-container').innerHTML = '';
                        });
                     }
                }
                
                document.getElementById(formId).addEventListener('submit', this.handleProfileUpdate);
            },
            async handleProfileUpdate(e) {
                e.preventDefault();
                const formId = e.target.id;
                const uid = AppState.session.currentUser.uid;
                let updates = {};
                
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Saving...';

                try {
                    if (formId === 'picture-edit-form') {
                        const pictureSource = document.getElementById('edit-picture-source').value;
                        if (pictureSource === 'file') {
                            const pictureFile = document.getElementById('edit-picture').files[0];
                            if (pictureFile) {
                                const url = await this.uploadFileForUser(pictureFile);
                                updates.profileImageUrl = url;
                            }
                        } else {
                            const imageUrl = document.getElementById('edit-picture-url').value;
                            if (imageUrl) updates.profileImageUrl = imageUrl.trim();
                        }
                    } else if (formId === 'personal-edit-form') {
                        updates.name = document.getElementById('edit-name').value;
                        updates.mobile = document.getElementById('edit-mobile').value;
                    } else if (formId === 'other-edit-form') {
                        updates.exam = document.getElementById('edit-exam').value;
                        updates.class = document.getElementById('edit-class').value;
                        updates.city = document.getElementById('edit-city').value;
                        updates.state = document.getElementById('edit-state').value;
                    }

                    if (Object.keys(updates).length > 0) {
                        await db.ref('users/' + uid).update(updates);
                    }
                } catch (error) {
                    alert("Failed to update profile: " + error.message);
                } finally {
                    document.getElementById('modal-container').innerHTML = '';
                }
            },
            showPasswordChangeModal() {
                const title = "Change Password";
                const formId = "password-change-form";
                const formContent = `
                    <div class="form-group">
                        <label>Current Password</label>
                        <div class="password-wrapper"><input type="password" id="current-password" required><button type="button" class="password-toggle">👁️</button></div>
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <div class="password-wrapper"><input type="password" id="new-password" minlength="6" required><button type="button" class="password-toggle">👁️</button></div>
                    </div>
                     <div class="form-group">
                        <label>Confirm New Password</label>
                        <div class="password-wrapper"><input type="password" id="confirm-new-password" minlength="6" required><button type="button" class="password-toggle">👁️</button></div>
                    </div>
                    <a class="clickable-link" id="modal-forgot-password">Forgot Password?</a>
                `;
                const modalContent = `<form id="${formId}">${formContent}<button type="submit" class="btn btn-primary" style="width:100%; margin-top: 15px;">Update Password</button></form>`;
                UI.showModal(title, modalContent);
                document.getElementById(formId).addEventListener('submit', this.handleChangePassword);
                document.getElementById('modal-forgot-password').addEventListener('click', () => {
                    document.querySelector('.modal-overlay').remove();
                    this.navigateToPage('page-auth-forgot-password');
                });
            },
            async handleChangePassword(e) {
                e.preventDefault();
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmNewPassword = document.getElementById('confirm-new-password').value;

                if (newPassword !== confirmNewPassword) {
                    alert("New passwords do not match.");
                    return;
                }
                
                const user = auth.currentUser;
                if (!user) return;

                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Updating...';

                try {
                    await user.reauthenticateWithCredential(credential);
                    await user.updatePassword(newPassword);
                    alert("Password updated successfully!");
                    document.getElementById('modal-container').innerHTML = '';
                } catch (error) {
                    alert("Failed to update password. Please check your current password. Error: " + error.message);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Update Password';
                }
            },
            formatTimeAgo(ts) { if (!ts) return ''; const s = Math.floor((Date.now() - ts) / 1000); let i = s / 31536000; if (i > 1) return Math.floor(i) + " years ago"; i = s / 2592000; if (i > 1) return Math.floor(i) + " months ago"; i = s / 86400; if (i > 1) return Math.floor(i) + " days ago"; i = s / 3600; if (i > 1) return Math.floor(i) + " hours ago"; i = s / 60; if (i > 1) return Math.floor(i) + " minutes ago"; return "just now"; },            
            handlePasswordReset(email, button) {
                button.disabled = true;
                button.textContent = 'Sending...';
                auth.sendPasswordResetEmail(email).then(() => {
                    alert("पासवर्ड रीसेट लिंक आपके ईमेल पर भेज दिया गया है।"); this.navigateToPage('page-auth-login');
                }).catch(err => {
                    alert(err.code === 'auth/user-not-found' ? "इस ईमेल से कोई खाता रजिस्टर्ड नहीं है।" : "लिंक भेजने में विफल।");
                }).finally(() => {
                    button.disabled = false;
                    button.textContent = 'रीसेट लिंक भेजें';
                });
            },
            login(email, pass, button) {
                button.disabled = true;
                button.textContent = 'Logging in...';
                auth.signInWithEmailAndPassword(email, pass).catch(err => {
                    alert("ईमेल या पासवर्ड गलत है।");
                    button.disabled = false;
                    button.textContent = 'Login';
                });
            },
            signup(name, userClass, email, mobile, pass, confirmPass, button) {
                if (pass !== confirmPass) { alert("Passwords do not match!"); return; }
                button.disabled = true;
                button.textContent = 'Creating Account...';
                auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                    const userData = { name: name, class: userClass, email: email, mobile: mobile || null, enrolledCourses: {}, xp: 0, level: 1, isBlocked: false, completedLectures: {}, notificationsLastChecked: 0 };
                    db.ref('users/' + cred.user.uid).set(userData);
                }).catch(err => {
                    alert(err.code === 'auth/email-already-in-use' ? "यह ईमेल पहले से ही रजिस्टर्ड है।" : "अकाउंट नहीं बन सका।");
                    button.disabled = false;
                    button.textContent = 'Create Account';
                });
            },
            handleLogout() {
                const logoutBtn = document.getElementById('logout-btn');
                const profileLogoutBtn = document.getElementById('profile-logout-btn');
                if (logoutBtn) { logoutBtn.disabled = true; logoutBtn.textContent = 'Logging out...'; }
                if (profileLogoutBtn) { profileLogoutBtn.disabled = true; profileLogoutBtn.textContent = 'Logging out...'; }
                
                auth.signOut().catch(error => {
                    console.error("Logout failed:", error);
                    alert("Logout failed. Please try again.");
                    if (logoutBtn) { logoutBtn.disabled = false; logoutBtn.textContent = 'Logout'; }
                    if (profileLogoutBtn) { profileLogoutBtn.disabled = false; profileLogoutBtn.textContent = 'Logout'; }
                });
            },
            enroll(id) { if (!AppState.session.currentUser) { this.navigateToPage('page-auth-login'); return; } db.ref(`users/${AppState.session.currentUser.uid}/enrolledCourses/${id}`).set(true).then(() => { alert('Enrolled successfully!'); UI.hideDetailPage(); document.getElementById('modal-container').innerHTML = ''; this.navigateToPage('page-my-courses', false); }).catch(err => alert(err.message)); },
            
            buy(id) { 
                if (!AppState.session.currentUser) { this.navigateToPage('page-auth-login'); return; }
                const course = AppState.data.courses.find(c => c.id === id);
                if (!course) { alert('Course not found!'); return; }
                const orderId = `ASAG-${Date.now()}-${Math.random().toString(36).substr(2, 5).toUpperCase()}`;
                this.navigateToPage('page-payment-gateway');
                UI.renderPaymentPage(course, orderId);
            },
            
            handleUtrSubmit(form) {
                const utrInput = document.getElementById('utr-input');
                const utr = utrInput.value.trim();
                
                if (utr.length !== 12 || !/^\d+$/.test(utr)) {
                    alert('Please enter a valid 12-digit UTR number.');
                    return;
                }
                
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                const requestData = {
                    orderId: form.dataset.orderId, courseId: form.dataset.courseId,
                    courseTitle: form.dataset.courseTitle, coursePrice: form.dataset.coursePrice,
                    userSubmittedUTR: utr, status: 'pending', userId: AppState.session.currentUser.uid,
                    userName: AppState.session.userData.name, userEmail: AppState.session.userData.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                db.ref('paymentRequests').push(requestData)
                    .then(() => {
                        UI.showModal('Request Submitted Successfully!', 'Your payment confirmation has been received. Your course will be activated within a few hours after verification. Thank you!', false);
                        setTimeout(() => {
                            document.getElementById('modal-container').innerHTML = '';
                            this.navigateToPage('page-my-courses');
                        }, 4000);
                    })
                    .catch(error => {
                        alert('Failed to submit request: ' + error.message);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit & Confirm Payment';
                    });
            },
            handleSearch(term) { if (!term) { document.getElementById('search-results-grid').innerHTML = ''; return; } const results = AppState.data.courses.filter(c => c.title.toLowerCase().includes(term.toLowerCase())); UI.renderCourses('search-results-grid', results, `No results for "${term}"`); },
            markLectureAsComplete(lectureId) {
                if (!lectureId || !AppState.session.currentUser) return;
                const user = AppState.session.userData;
                const completedLectures = user.completedLectures || {};
                
                if (completedLectures[lectureId]) return; // Already completed, no XP gain

                this.updateUserXP(50); // Give 50 XP for completing a video
                const updates = {};
                updates[`/users/${AppState.session.currentUser.uid}/completedLectures/${lectureId}`] = true;
                db.ref().update(updates);
                
                const checkmark = document.querySelector(`.content-complete-btn[data-lecture-id="${lectureId}"]`);
                if(checkmark) {
                    checkmark.classList.add('completed');
                    checkmark.innerHTML = '✔';
                }
            },
            updateUserXP(xpToAdd) {
                if (!AppState.session.currentUser || xpToAdd <= 0) return;
                const user = AppState.session.userData;
                const currentXp = user.xp || 0;
                const newXp = currentXp + xpToAdd;
                db.ref(`users/${AppState.session.currentUser.uid}/xp`).set(newXp);
            },
            startXpCounter() {
                if (AppState.ui.xpInterval) clearInterval(AppState.ui.xpInterval);
                AppState.ui.xpInterval = setInterval(() => {
                    const videoPlayer = document.getElementById('video-player-element');
                    if (!AppState.session.currentUser || (videoPlayer && videoPlayer.paused)) {
                        this.stopXpCounter();
                        return;
                    }
                    this.updateUserXP(2); // 2 XP per minute
                }, 60000);
            },
            stopXpCounter() {
                if (AppState.ui.xpInterval) {
                    clearInterval(AppState.ui.xpInterval);
                    AppState.ui.xpInterval = null;
                }
            },
            firebaseObjectToArray(obj) { if (!obj) return []; return Object.keys(obj).map(key => ({ id: key, ...obj[key] })); },
            navigateBack() {
                const previousPage = AppState.ui.navigationHistory.pop();
                if (previousPage) {
                    this.navigateToPage(previousPage, false);
                } else {
                    this.navigateToPage('page-home', false);
                }
            },
            navigateToPage(pageId, addToHistory = true, params = {}) {
                if (AppState.ui.liveStatusInterval) {
                    clearInterval(AppState.ui.liveStatusInterval);
                    AppState.ui.liveStatusInterval = null;
                }

                if (!pageId) return;
                if(AppState.ui.xpInterval) {
                    clearInterval(AppState.ui.xpInterval);
                    AppState.ui.xpInterval = null;
                }
                
                const currentPage = document.querySelector('.page.active');
                if (currentPage && addToHistory && currentPage.id !== pageId) {
                     if(!['page-quiz-result', 'page-quiz-ranks', 'page-payment-gateway', 'page-dashboard'].includes(currentPage.id) && !currentPage.id.startsWith('page-mcq') && !currentPage.id.startsWith('page-test')) {
                        AppState.ui.navigationHistory.push(currentPage.id);
                     }
                }
                
                if(pageId === 'page-home') AppState.ui.navigationHistory = [];

                const mainAppContainer = document.getElementById('main-app-container');
                const authContainer = document.getElementById('auth-container');
                const isAuthPage = pageId.startsWith('page-auth-');

                if (isAuthPage) {
                    mainAppContainer.style.display = 'none';
                    authContainer.style.display = 'flex';
                } else if (AppState.session.currentUser) {
                    mainAppContainer.style.display = 'block';
                    authContainer.style.display = 'none';
                }

                UI.hideDetailPage();
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                const newPage = document.getElementById(pageId);
                if(newPage) {
                    newPage.classList.add('active');
                    if (newPage.scrollTop > 0) newPage.scrollTop = 0;
                }
                
                const header = document.querySelector('.app-header');
                const footer = document.querySelector('.bottom-nav');
                
                const pagesWithStandardNav = ['page-home', 'page-my-courses', 'page-search', 'page-profile'];
                const showStandardNav = pagesWithStandardNav.includes(pageId) && !isAuthPage;

                header.style.display = showStandardNav ? 'flex' : 'none';
                footer.style.display = showStandardNav ? 'flex' : 'none';

                if (pageId.startsWith('page-auth-')) {
                     header.style.display = 'none';
                     footer.style.display = 'none';
                }
                
                mainAppContainer.style.paddingBottom = showStandardNav ? 'var(--bottom-nav-height)' : '0';
                
                if (isAuthPage) {
                    document.querySelectorAll('.auth-nav-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`.auth-nav-btn[data-page="${pageId}"]`)?.classList.add('active');
                } else {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelector(`.nav-item[data-page="${pageId}"]`)?.classList.add('active');
                    this.loadPageContent(pageId, params);
                }
            },
            loadPageContent(pageId, params = {}) {
                if (pageId.startsWith('page-auth-') || ['page-quiz-result', 'page-quiz-ranks', 'page-payment-gateway', 'page-live-class'].includes(pageId)) return;
                
                const filterablePages = ['page-mcq', 'page-pdf', 'page-test'];
                if (filterablePages.includes(pageId)) {
                    const type = pageId.replace('page-', '');
                    UI.renderFilterBar(type);
                     const filterContainer = document.getElementById(`${type}-filter-container`);
                    if(filterContainer) filterContainer.style.display = 'flex';
                }

                if (pageId === 'page-home') {
                    const { userData } = AppState.session; 
                    const allCourses = AppState.data.courses;
                    const ourBatchesGrid = document.getElementById('home-our-batches-grid');
                    const otherBatchesGrid = document.getElementById('home-other-batches-grid');

                    if (!userData || !allCourses) {
                        ourBatchesGrid.innerHTML = `<div class="empty-state">Loading batches...</div>`;
                        otherBatchesGrid.innerHTML = '';
                        document.getElementById('home-other-batches-container').style.display = 'none';
                        return;
                    }

                    if (userData.class) {
                        const userClass = String(userData.class).trim();
                        const ourBatches = allCourses.filter(c => String(c.class).trim() === userClass);
                        const otherBatches = allCourses.filter(c => String(c.class).trim() !== userClass);
                        UI.renderCourses('home-our-batches-grid', ourBatches, "No batches found for your class.");
                        UI.renderCourses('home-other-batches-grid', otherBatches, "");
                        document.getElementById('home-our-batches-container').style.display = 'block';
                        document.getElementById('home-other-batches-container').style.display = otherBatches.length > 0 ? 'block' : 'none';
                    } else {
                        UI.renderCourses('home-our-batches-grid', allCourses, "No courses available. Please set your class in Profile to see relevant batches.");
                        document.getElementById('home-other-batches-container').style.display = 'none';
                    }
                }
                else if (pageId === 'page-my-courses') { if (!AppState.session.userData) UI.renderCourses('my-courses-grid', [], 'Please login to see your courses.'); else { const enrolledIds = Object.keys(AppState.session.userData.enrolledCourses || {}); const enrolled = AppState.data.courses.filter(c => enrolledIds.includes(c.id)); UI.renderCourses('my-courses-grid', enrolled, "You haven't enrolled in any courses yet."); } }
                else if (pageId === 'page-search') { setTimeout(() => document.getElementById('search-input').focus(), 100); }
                else if (pageId === 'page-notifications') UI.renderNotificationsPage();
                else if (pageId === 'page-mcq') UI.renderQuizList('mcq');
                else if (pageId === 'page-test') UI.renderQuizList('test');
                else if (pageId === 'page-pdf') UI.renderPdfs(AppState.data.pdfs);
                else if (pageId === 'page-profile') this.renderProfilePage();
                else if (pageId === 'page-about-us') this.renderAboutUsPage();
                else if (pageId === 'page-contact-us') this.renderUserChatInterface();
                else if (pageId === 'page-all-other-batches') {
                    const { userData } = AppState.session; const allCourses = AppState.data.courses;
                    if (userData && userData.class) {
                        const userClass = String(userData.class).trim();
                        const otherBatches = allCourses.filter(c => String(c.class).trim() !== userClass);
                        UI.renderCourses('all-other-batches-grid', otherBatches, "No other batches available.");
                    }
                }
                else if (pageId === 'page-leaderboard') {
                    UI.renderLevelCarousel(AppState.session.userData?.level || 1);
                    if (AppState.data.leaderboard && AppState.data.leaderboard.length > 0) {
                        UI.renderLeaderboard(AppState.data.leaderboard);
                    } else {
                        document.getElementById('leaderboard-container').innerHTML = `<div class="empty-state">Loading leaderboard...</div>`;
                    }
                } else if (pageId === 'page-video-player') {
                    this.renderVideoPlayer();
                } else if (pageId === 'page-study') {
                    this.renderStudyPage();
                } else if (pageId === 'page-dashboard') {
                    this.renderDashboard(params.batchId);
                }
            },
            updateFilter(type, newFilter) {
                AppState.ui.filters[type] = newFilter;
                const container = document.getElementById(`${type}-filter-container`);
                if (container) {
                    container.querySelector('.filter-bar-btn').classList.toggle('active', newFilter === 'all');
                    const select = container.querySelector('.filter-bar-select');
                    select.value = newFilter;
                }
                this.loadPageContent(`page-${type}`);
            },
            showCourseContentsPage(courseId) { const course = AppState.data.courses.find(c => c.id === courseId); if (!course) { alert('Error: Course not found.'); return; } this.navigateToPage('page-course-contents'); UI.renderCourseSubjects(course); },
            showBuyNowPage(courseId) { const course = AppState.data.courses.find(c => c.id === courseId); if (!course) { alert('Error: Course not found.'); return; } this.navigateToPage('page-buy-now'); UI.renderBuyNowPage(course); },
            showChaptersPage(courseId, subjectId, subjectTitle) { this.navigateToPage('page-chapters'); UI.renderChapters(courseId, subjectId, subjectTitle); },
            showLecturesPage(courseId, subjectId, chapterId, chapterTitle) { this.navigateToPage('page-lectures'); UI.renderLectures(courseId, subjectId, chapterId, chapterTitle); },
            showQuizRanksPage(quizId, quizTitle) { this.navigateToPage('page-quiz-ranks'); UI.renderQuizRanksPage(quizId, quizTitle); },
            
            showVideoPlayerPage(item) {
                AppState.ui.commentsToShow = 5;
                AppState.ui.questionsToShow = 5;
                AppState.ui.currentVideoItem = item;
                this.navigateToPage('page-video-player');
            },

            renderVideoPlayer() {
                const item = AppState.ui.currentVideoItem;
                if (!item) return;

                const videoHeaderTitle = document.getElementById('video-header-title');
                const videoPlayer = document.getElementById('video-player-element');
                const iframeContainer = document.getElementById('iframe-player-container');
                const titleEl = document.getElementById('video-player-title');
                const pdfBtn = document.getElementById('video-pdf-btn');
                const downloadBtn = document.getElementById('video-download-btn');
                const form = document.getElementById('video-input-form');
                
                videoPlayer.style.display = 'none';
                iframeContainer.style.display = 'none';
                iframeContainer.innerHTML = '';
                videoPlayer.src = '';

                videoHeaderTitle.textContent = item.title;
                titleEl.textContent = item.title;
                form.dataset.contentId = item.id;
                
                let videoUrl = item.url;
                const isYoutube = videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be');

                if (isYoutube) {
                    let videoId;
                    if (videoUrl.includes('youtube.com/watch?v=')) {
                        videoId = videoUrl.split('v=')[1].split('&')[0];
                    } else if (videoUrl.includes('youtu.be/')) {
                        videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
                    }
                    // ...पिछला कोड यहाँ तक था
                    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&modestbranding=1&rel=0`;
                    iframeContainer.innerHTML = `<iframe src="${embedUrl}" style="width:100%; height:100%; border:0;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
                    iframeContainer.style.display = 'block';
                } else {
                    videoPlayer.src = videoUrl;
                    videoPlayer.poster = item.playerThumbnail || item.thumbnail || '';
                    videoPlayer.style.display = 'block';
                }

                if (item.notesUrl) {
                    pdfBtn.dataset.url = item.notesUrl;
                    pdfBtn.dataset.title = `Notes: ${item.title}`;
                    pdfBtn.classList.remove('hidden');
                } else {
                    pdfBtn.classList.add('hidden');
                }

                // REMOVED: downloadedVideos check
                downloadBtn.classList.remove('downloaded');
                downloadBtn.querySelector('span').textContent = 'Download';
                downloadBtn.href = item.url;
                downloadBtn.setAttribute('download', `${item.title}.mp4`);
                downloadBtn.dataset.item = JSON.stringify(item);
                
                form.classList.add('hidden');
                document.getElementById('video-comments-btn').classList.remove('active');
                document.getElementById('video-ask-question-btn').classList.remove('active');

                this.setVideoPlayerMode('comments');
                this.loadComments(item.id);
                this.loadQuestions(item.id);

                videoPlayer.onended = () => this.markLectureAsComplete(item.id);
                videoPlayer.onplay = () => this.startXpCounter();
                videoPlayer.onpause = () => this.stopXpCounter();
            },
            
            setVideoPlayerMode(mode) {
                AppState.ui.videoPlayerMode = mode;
                
                const commentsBtn = document.getElementById('video-comments-btn');
                const askQuestionBtn = document.getElementById('video-ask-question-btn');
                const commentSection = document.getElementById('comment-section');
                const askQuestionSection = document.getElementById('ask-question-section');
                const input = document.getElementById('video-input');
                const form = document.getElementById('video-input-form');
                
                form.classList.remove('hidden');

                commentsBtn.classList.remove('active');
                askQuestionBtn.classList.remove('active');
                
                if (mode === 'comments') {
                    commentsBtn.classList.add('active');
                    commentSection.classList.remove('hidden');
                    askQuestionSection.classList.add('hidden');
                    input.placeholder = "Add a public comment...";
                } else {
                    askQuestionBtn.classList.add('active');
                    commentSection.classList.add('hidden');
                    askQuestionSection.classList.remove('hidden');
                    input.placeholder = "Ask your question privately...";
                }
            },

            loadComments(contentId) {
                const list = document.getElementById('comment-list');
                list.innerHTML = '<div class="empty-state" style="padding: 20px 0;">Loading comments...</div>';
                
                db.ref('comments/' + contentId).orderByChild('timestamp').on('value', snapshot => {
                    if (!snapshot.exists()) {
                        list.innerHTML = '<div class="empty-state" style="padding: 20px 0;">No comments yet. Be the first to comment!</div>';
                        return;
                    }
                    
                    const allComments = this.firebaseObjectToArray(snapshot.val()).reverse();
                    const commentsToRender = allComments.slice(0, AppState.ui.commentsToShow);

                    let commentsHtml = commentsToRender.map(comment => {
                        const author = comment.userName || 'Anonymous';
                        const initial = author.charAt(0).toUpperCase();
                        
                        const avatarHtml = comment.userProfileUrl
                            ? `<div class="comment-avatar"><img src="${comment.userProfileUrl}" alt="${author}"></div>`
                            : `<div class="comment-avatar">${initial}</div>`;

                        return `
                        <div class="comment-item">
                            ${avatarHtml}
                            <div class="comment-content">
                                <div class="comment-author-line">
                                    <div class="comment-author">${author}</div>
                                    <div class="comment-meta">${this.formatTimeAgo(comment.timestamp)}</div>
                                </div>
                                <div class="comment-text">${comment.text}</div>
                            </div>
                        </div>`;
                    }).join('');

                    if (allComments.length > AppState.ui.commentsToShow) {
                        commentsHtml += `<button id="see-more-comments-btn" class="btn btn-secondary" style="width:100%; margin-top:10px;">See More</button>`;
                    }
                    
                    list.innerHTML = commentsHtml;

                    const seeMoreBtn = document.getElementById('see-more-comments-btn');
                    if (seeMoreBtn) {
                        seeMoreBtn.addEventListener('click', () => {
                            AppState.ui.commentsToShow += 5;
                            this.loadComments(contentId);
                        });
                    }
                });
            },
            
            loadQuestions(contentId) {
                const list = document.getElementById('question-list');
                list.innerHTML = '<div class="empty-state" style="padding: 20px 0;">Loading questions...</div>';
                
                db.ref('questions/' + contentId).orderByChild('timestamp').on('value', snapshot => {
                    if (!snapshot.exists()) {
                        list.innerHTML = '<div class="empty-state" style="padding: 20px 0;">No questions yet.</div>';
                        return;
                    }
                    
                    const allQuestions = this.firebaseObjectToArray(snapshot.val()).reverse();
                    const questionsToRender = allQuestions.slice(0, AppState.ui.questionsToShow);

                    let questionsHtml = questionsToRender.map(q => {
                        const author = q.userName || 'Anonymous';
                        const initial = author.charAt(0).toUpperCase();

                        const avatarHtml = q.userProfileUrl
                            ? `<div class="question-avatar"><img src="${q.userProfileUrl}" alt="${author}"></div>`
                            : `<div class="question-avatar">${initial}</div>`;
                        
                        return `
                        <div class="question-item">
                            ${avatarHtml}
                            <div class="question-content">
                                <div class="comment-author-line">
                                    <div class="question-author">${author}</div>
                                    <div class="question-meta">${this.formatTimeAgo(q.timestamp)}</div>
                                </div>
                                <div class="question-text">${q.text}</div>
                            </div>
                        </div>`;
                    }).join('');

                    if (allQuestions.length > AppState.ui.questionsToShow) {
                        questionsHtml += `<button id="see-more-questions-btn" class="btn btn-secondary" style="width:100%; margin-top:10px;">See More</button>`;
                    }

                    list.innerHTML = questionsHtml;

                    const seeMoreBtn = document.getElementById('see-more-questions-btn');
                    if (seeMoreBtn) {
                        seeMoreBtn.addEventListener('click', () => {
                            AppState.ui.questionsToShow += 5;
                            this.loadQuestions(contentId);
                        });
                    }
                });
            },
            
            handleVideoInputSubmit(e) {
                e.preventDefault();
                if (!AppState.session.currentUser) {
                    alert('Please log in to post.');
                    return;
                }
                 if (AppState.session.userData && AppState.session.userData.isBlocked === true) {
                    alert('You have been blocked by the admin and cannot post comments.');
                    return;
                }
                const contentId = e.target.dataset.contentId;
                const input = document.getElementById('video-input');
                const text = input.value.trim();
                
                if (text && contentId) {
                    const mode = AppState.ui.videoPlayerMode;
                    const dbPath = mode === 'comments' ? 'comments' : 'questions';

                    const data = {
                        userId: AppState.session.currentUser.uid,
                        userName: AppState.session.userData.name,
                        userProfileUrl: AppState.session.userData.profileImageUrl || null,
                        text: text,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    db.ref(`${dbPath}/${contentId}`).push(data)
                        .then(() => {
                            input.value = '';
                            input.blur();
                        })
                        .catch(err => { alert('Failed to post: ' + err.message); });
                }
            },

            handleDirectDownload(btnElement) {
                // This function is now just for potential future use.
            },
            
            showPdfViewer(url, title = 'PDF Document') {
                if (!url) return;
                document.getElementById('pdf-viewer-title').textContent = title;
                document.getElementById('pdf-viewer-iframe').src = url;
                document.getElementById('pdf-download-link').href = url;
                document.getElementById('pdf-download-link').setAttribute('download', `${title}.pdf`);
                this.navigateToPage('page-pdf-viewer');
            },
            
            startQuiz(type, setId, source = 'global', questions = null, title = '') {
                let selectedSet;
                if (source === 'course') {
                    selectedSet = { id: setId, questions: AppController.firebaseObjectToArray(questions), title: title };
                } else {
                    const data = type === 'mcq' ? AppState.data.mcqs : AppState.data.tests;
                    selectedSet = data.find(set => set.id === setId);
                }
                
                if (!selectedSet) { alert("Error: Could not find the selected set."); return; } 
                
                AppState.quiz = {
                    type: type,
                    questions: (source === 'course') ? selectedSet.questions : AppController.firebaseObjectToArray(selectedSet.questions),
                    currentIndex: 0,
                    userAnswers: {},
                    isSubmitted: {},
                    source: source,
                    id: setId,
                    title: selectedSet.title
                }; 
                
                const quizPageId = `page-${type}`;
                this.navigateToPage(quizPageId);
                UI.renderQuiz(); 
            },

            navigateQuiz(direction) { const { currentIndex, questions } = AppState.quiz; const newIndex = currentIndex + direction; if (newIndex >= 0 && newIndex < questions.length) { AppState.quiz.currentIndex = newIndex; UI.renderQuiz(); } },
            submitQuizAnswer() { 
                const { currentIndex, userAnswers } = AppState.quiz; 
                const qIndex = currentIndex; 
                if (userAnswers[qIndex] === undefined) { 
                    alert("Please select an option first."); 
                    return; 
                } 
                AppState.quiz.isSubmitted[qIndex] = true; 
                UI.renderQuiz(); 
            },

            // --- NEW/MODIFIED FUNCTIONS FOR STUDY & DASHBOARD ---
            renderHeaderXP() {
                const xpDisplay = document.getElementById('header-xp-display');
                if (xpDisplay && AppState.session.userData) {
                    const xpValue = xpDisplay.querySelector('.xp-value');
                    xpValue.textContent = AppState.session.userData.xp || 0;
                }
            },

            renderStudyPage() {
                this.renderHeaderXP();
                const container = document.getElementById('study-page-content');
                const user = AppState.session.userData;
                if (!user || !user.enrolledCourses || Object.keys(user.enrolledCourses).length === 0) {
                    container.innerHTML = `<div class="study-main-area"><div class="empty-state">You are not enrolled in any batch.</div></div>`;
                    return;
                }

                const enrolledIds = Object.keys(user.enrolledCourses);
                const enrolledCourses = AppState.data.courses.filter(c => enrolledIds.includes(c.id));

                if (enrolledCourses.length === 0) {
                    container.innerHTML = `<div class="study-main-area"><div class="empty-state">You have no active batches.</div></div>`;
                    return;
                }
                
                if (!AppState.ui.selectedStudyBatchId || !enrolledIds.includes(AppState.ui.selectedStudyBatchId)) {
                    AppState.ui.selectedStudyBatchId = enrolledIds[0];
                }

                const batchOptions = enrolledCourses.map(course => 
                    `<option value="${course.id}" ${AppState.ui.selectedStudyBatchId === course.id ? 'selected' : ''}>${course.title}</option>`
                ).join('');

                container.innerHTML = `
                    <div class="study-header">
                        <select id="study-batch-selector">${batchOptions}</select>
                    </div>
                    <div id="study-dynamic-content">
                        <div class="empty-state">Loading schedule...</div>
                    </div>
                `;
                
                document.getElementById('study-batch-selector').addEventListener('change', (e) => {
                    AppState.ui.selectedStudyBatchId = e.target.value;
                    this.renderStudyPageContent(AppState.ui.selectedStudyBatchId);
                });

                this.renderStudyPageContent(AppState.ui.selectedStudyBatchId);
            },
            
            renderStudyPageContent(batchId) {
                const container = document.getElementById('study-dynamic-content');
                if (!container) return;

                const allSchedules = this.firebaseObjectToArray(AppState.data.schedules);

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                const schedulesForBatchToday = allSchedules
                    .filter(s => {
                        if (s.courseId !== batchId) return false;
                        const startTime = new Date(s.startTime);
                        return startTime >= today && startTime < tomorrow;
                    })
                    .sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

                let mainAreaHtml = '';

                if (schedulesForBatchToday.length === 0) {
                    mainAreaHtml += `
                        <h3 class="study-section-title">Today's Class</h3>
                        <div class="empty-state" style="padding: 20px;">No Class scheduled for today!</div>
                    `;
                } else {
                    const classesHtml = schedulesForBatchToday.map(schedule => {
                        const startTime = new Date(schedule.startTime);
                        let statusClass = 'upcoming';
                        let statusText = 'UPCOMING';
                        if (schedule.status === 'live') {
                            statusClass = 'live';
                            statusText = 'LIVE';
                        } else if (schedule.status === 'ended') {
                            statusClass = 'ended';
                            statusText = 'ENDED';
                        }
                        const timeString = !isNaN(startTime) 
                            ? startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit'})
                            : 'Invalid Time';
                        return `
                        <div class="class-card" data-schedule-id="${schedule.id}">
                            <div class="class-card-thumbnail">
                                <img src="${schedule.thumbnail}" alt="${schedule.title}">
                                <div class="class-card-overlay">
                                    <span class="class-card-teacher">${schedule.teacherName || ''}</span>
                                </div>
                                <div class="class-status-badge ${statusClass}">${statusText}</div>
                            </div>
                            <div class="class-card-content">
                                <h4>${schedule.title}</h4>
                                <p class="class-time">
                                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"></path><path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"></path></svg>
                                    <span>${timeString}</span>
                                </p>
                            </div>
                        </div>`;
                    }).join('');
                    mainAreaHtml += `
                        <h3 class="study-section-title">Today's Class</h3>
                        <div class="today-classes-container">${classesHtml}</div>
                        <a href="#" class="view-all-classes-link" data-batch-id="${batchId}">View All Classes</a>
                    `;
                }

                mainAreaHtml += `
                    <h3 class="study-section-title">My Study Zone</h3>
                    <div class="my-learning-grid">
                         <a href="#" class="learning-shortcut-btn" data-page="page-my-courses">
                            <svg fill="currentColor" viewBox="0 0 24 24" height="28px" width="28px"><path d="M4 14h4v-4H4v4zm0 5h4v-4H4v4zM4 9h4V5H4v4zm5 5h12v-4H9v4zm0 5h12v-4H9v4zM9 5v4h12V5H9z"></path></svg>
                            <span>My Batches</span>
                         </a>
                         <a href="#" class="learning-shortcut-btn" data-page="page-dashboard">
                             <svg fill="currentColor" viewBox="0 0 24 24" height="28px" width="28px"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path></svg>
                             <span>Dashboard</span>
                         </a>
                    </div>
                `;
                
                const footerHtml = `
                    <div style="text-align: left; padding: 40px 20px 20px; color: #777; margin-top: auto;">
                        <p style="font-weight: 600; font-size: 1.1rem; color: var(--text-color);">Apna Study, Apna Sapna —</p>
                        <p style="font-weight: 500; font-size: 1rem; margin-bottom: 10px;">Success Ka Apna Group!</p>
                        <p style="font-size: 0.9rem;">❤️ From APNA STUDY APNA GROUP</p>
                    </div>
                `;

                container.innerHTML = `<div class="study-main-area">${mainAreaHtml}</div>${footerHtml}`;

                if (schedulesForBatchToday.length > 0) {
                    container.querySelector('.view-all-classes-link').addEventListener('click', e => {
                        e.preventDefault();
                        this.showCourseContentsPage(e.target.dataset.batchId);
                    });
                    container.querySelectorAll('.class-card').forEach(card => {
                        card.addEventListener('click', e => {
                            const scheduleId = e.currentTarget.dataset.scheduleId;
                            const schedule = schedulesForBatchToday.find(s => s.id === scheduleId);
                            if (schedule && schedule.status === 'live') {
                                this.joinLiveClass(schedule);
                            } else {
                                alert("This class is not live right now.");
                            }
                        });
                    });
                }
                
                if(AppState.ui.liveStatusInterval) clearInterval(AppState.ui.liveStatusInterval);
            },

            async renderDashboard(batchId) {
                const container = document.getElementById('dashboard-content');
                container.innerHTML = `<div class="empty-state">Loading dashboard...</div>`;
                if (!batchId) {
                    container.innerHTML = `<div class="empty-state">Please select a batch from the Study page first.</div>`;
                    return;
                }

                const course = AppState.data.courses.find(c => c.id === batchId);
                const user = AppState.session.userData;
                const completedLectures = user.completedLectures || {};
                
                let totalLectures = 0;
                let completedCount = 0;
                let totalTestsInDB = 0; // Renamed for clarity
                let attemptedTestsCount = 0;

                // Calculate total lectures and completed lectures
                const subjects = this.firebaseObjectToArray(course.subjects);
                for (const subject of subjects) {
                    const chapters = this.firebaseObjectToArray(subject.chapters);
                    for (const chapter of chapters) {
                        const contents = this.firebaseObjectToArray(chapter.content);
                        contents.forEach(content => {
                            if (content.type === 'video') {
                                totalLectures++;
                                if (completedLectures[content.id]) {
                                    completedCount++;
                                }
                            }
                            if (content.type === 'test') {
                                totalTestsInDB++;
                            }
                        });
                    }
                }
                
                // Calculate attempted tests from the global tests list that belong to this course
                const allTestsInCourse = AppState.data.tests.filter(t => t.courseId === batchId);
                const quizResultsRef = db.ref('quizResults');
                const userQuizResultsPromises = allTestsInCourse.map(test => 
                    quizResultsRef.child(test.id).child(user.id).once('value')
                );
                
                const resultsSnapshots = await Promise.all(userQuizResultsPromises);
                attemptedTestsCount = resultsSnapshots.filter(snap => snap.exists()).length;

                container.innerHTML = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <span class="icon">📚</span>
                            <h3>Lectures</h3>
                        </div>
                        <div class="dashboard-stat">
                            <span class="label">Lectures Completed</span>
                            <span class="value">${completedCount} <span>/ ${totalLectures}</span></span>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <span class="icon">📝</span>
                            <h3>Tests</h3>
                        </div>
                         <div class="dashboard-stat">
                            <span class="label">Tests Attempted</span>
                            <span class="value">${attemptedTestsCount} <span>/ ${totalTestsInDB}</span></span>
                        </div>
                    </div>
                </div>
                `;
            },

            joinLiveClass(schedule) {
                AppState.ui.currentLiveSchedule = schedule;
                this.navigateToPage('page-live-class');
                this.renderLiveClassPage(schedule);
            },

            renderLiveClassPage(schedule) {
                const container = document.getElementById('live-class-content-container');
                document.querySelector('#page-live-class .detail-title').textContent = schedule.title;
                
                let videoUrl = schedule.videoUrl;
                if (videoUrl.includes('youtube.com/watch?v=')) {
                    const videoId = videoUrl.split('v=')[1].split('&')[0];
                    videoUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&modestbranding=1&rel=0`;
                } else if (videoUrl.includes('youtu.be/')) {
                    const videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
                    videoUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&modestbranding=1&rel=0`;
                }

                container.innerHTML = `
                    <div class="live-video-wrapper">
                        <iframe src="${videoUrl}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                    </div>
                    <div class="live-details-and-chat">
                        <div class="live-video-details">
                            <h3 id="live-video-title">${schedule.title}</h3>
                        </div>
                        <div id="live-chat-section">
                            <div id="live-chat-messages"><div class="empty-state">Loading chat...</div></div>
                            <div class="live-chat-form-wrapper">
                                <form id="live-chat-form">
                                    <input type="text" id="live-chat-input" placeholder="Say something..." required>
                                    <button type="submit" class="btn btn-primary">
                                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                                    </button>
                                </form>
                                <p class="live-chat-subtext"
                            </div>
                        </div>
                    </div>
                `;
                const liveChatInput = document.getElementById('live-chat-input');
                if (liveChatInput) {
                    liveChatInput.addEventListener('focus', () => {
                        setTimeout(() => {
                           const formWrapper = document.querySelector('.live-chat-form-wrapper');
                           if(formWrapper) formWrapper.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }, 300);
                    });
                }

                this.loadLiveChatMessages(schedule.id);
            },
            
            loadLiveChatMessages(scheduleId) {
                const chatArea = document.getElementById('live-chat-messages');
                db.ref(`liveChats/${scheduleId}`).orderByChild('timestamp').on('value', snapshot => {
                    if (!chatArea) return; 
                    if (!snapshot.exists()) {
                        chatArea.innerHTML = '<div class="empty-state" style="padding: 10px 0;">Be the first to chat!</div>';
                        return;
                    }
                    const messages = this.firebaseObjectToArray(snapshot.val());
                    chatArea.innerHTML = messages.map(msg => {
                        const author = msg.userName || 'Anonymous';
                        const initial = author.charAt(0).toUpperCase();
                        const avatarHtml = msg.userProfileUrl ? 
                            `<div class="comment-avatar"><img src="${msg.userProfileUrl}" alt="${author}"></div>` : 
                            `<div class="comment-avatar">${initial}</div>`;

                        return `
                        <div class="comment-item">
                            ${avatarHtml}
                            <div class="comment-content">
                                <div class="comment-author-line">
                                    <div class="comment-author">${author}</div>
                                    <div class="comment-meta">${this.formatTimeAgo(msg.timestamp)}</div>
                                </div>
                                <div class="comment-text">${msg.text}</div>
                            </div>
                        </div>`;
                    }).join('');
                    
                    chatArea.scrollTop = chatArea.scrollHeight;
                });
            },
            
            handleLiveChatMessageSend(e) {
                e.preventDefault();
                const schedule = AppState.ui.currentLiveSchedule;
                const user = AppState.session.userData;
                const input = document.getElementById('live-chat-input');
                const text = input.value.trim();

                if (!text || !schedule || !user) return;
                 if (user.isBlocked === true) {
                    alert('You have been blocked by the admin and cannot post comments.');
                    return;
                }
                
                const messageData = {
                    userId: AppState.session.currentUser.uid,
                    userName: user.name,
                    userProfileUrl: user.profileImageUrl || null,
                    text: text,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                db.ref(`liveChats/${schedule.id}`).push(messageData).then(() => {
                    input.value = '';
                }).catch(err => {
                    alert('Could not send message: ' + err.message);
                });
            },
            
            handleLiveClassBack() {
                const schedule = AppState.ui.currentLiveSchedule;
                if(schedule) {
                    db.ref(`liveChats/${schedule.id}`).off();
                }
                AppState.ui.currentLiveSchedule = null;
                const container = document.getElementById('live-class-content-container');
                if(container) container.innerHTML = '';
                this.navigateBack();
            },

            showImageViewer(src) {
                const modal = document.getElementById('image-viewer-modal');
                const img = document.getElementById('image-viewer-img');
                img.src = src;
                img.classList.remove('zoomed');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            },

            hideImageViewer() {
                const modal = document.getElementById('image-viewer-modal');
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        };
        window.AppController = AppController;
        AppController.init();
    });
</script>
<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(function(registration) {
                console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch(function(error) {
                console.log('Service Worker registration failed:', error);
            });
    }
</script>
</body>
</html>
